<script>
    // --- Global Firebase References (declared here, assigned after init) ---
    // These need to be accessible by functions that are called by onclick/oninput handlers.
    let db;
    let salesCollection;

    // --- GLOBAL UTILITIES AND CONSTANTS (Accessible throughout the script) ---
    const bananaTypes = ["Red Banana", "Robusta", "Matti", "Athan"];

    function showFlashMessage(message, type) {
        const flashContainer = document.getElementById('flash-message-container');
        flashContainer.textContent = message;
        flashContainer.className = `flash-message ${type} block`;
        setTimeout(() => {
            flashContainer.className = `flash-message ${type} hidden`;
        }, 5000); // Hide after 5 seconds
    }

    // --- Product Row HTML Generation (used by both Add/Edit modals) ---
    function createProductRowHtml(index, bananaType = '', weightKg = '', quantity = '', isEdit = false) {
        const idPrefix = isEdit ? 'edit-' : 'new-';
        // Ensure oninput calls correct total update function
        const onInputChange = isEdit ? 'updateEditTotals()' : 'updateNewTotals()';

        const removeButtonHtml = `
            <div class="flex justify-end sm:justify-start">
                <button type="button" onclick="${isEdit ? 'removeEditProductRow(this)' : 'removeNewProductRow(this)'}" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">
                    Remove
                </button>
            </div>`;

        return `
            <div class="product-row grid grid-cols-1 sm:grid-cols-4 gap-3 mb-3 p-3 bg-gray-50 rounded-md shadow-sm items-end" id="product-row-${idPrefix}${index}">
                <div>
                    <label for="${idPrefix}banana_type-${index}" class="block text-sm font-medium text-gray-700">Banana Type</label>
                    <select
                        id="${idPrefix}banana_type-${index}"
                        name="banana_type[]"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                        required
                    >
                        <option value="">Select Type</option>
                        ${bananaTypes.map(type => `<option value="${type}" ${bananaType === type ? 'selected' : ''}>${type}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="${idPrefix}weight_kg-${index}" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                    <input
                        type="number"
                        id="${idPrefix}weight_kg-${index}"
                        name="weight_kg[]"
                        value="${weightKg}"
                        placeholder="e.g., 100"
                        step="0.01"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                        required
                        oninput="${onInputChange}"
                    />
                </div>
                <div>
                    <label for="${idPrefix}quantity-${index}" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input
                        type="number"
                        id="${idPrefix}quantity-${index}"
                        name="quantity[]"
                        value="${quantity}"
                        placeholder="e.g., 50"
                        step="1"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                        required
                        oninput="${onInputChange}"
                    />
                </div>
                ${removeButtonHtml}
            </div>
        `;
    }

    // Function to update visibility of remove buttons based on row count
    function updateRemoveButtons(formType) {
        const containerId = formType === 'new' ? 'new-products-container' : 'edit-products-container';
        const container = document.getElementById(containerId);
        const productRows = container.querySelectorAll('.product-row');

        productRows.forEach(row => {
            const removeButtonDiv = row.querySelector('.flex.justify-end.sm\\:justify-start');
            if (removeButtonDiv) {
                const removeButton = removeButtonDiv.querySelector('button');
                if (removeButton) {
                    if (productRows.length <= 1) {
                        removeButton.style.display = 'none'; // Hide if only one row
                    } else {
                        removeButton.style.display = 'inline-block'; // Show if more than one row
                    }
                }
            }
        });
    }

    // --- New Sale Form Specific Functions (must be global for inline calls) ---
    let newProductRowCounter = 0; // Reset counter for new form
    function addInitialNewProductRow() {
        const container = document.getElementById('new-products-container');
        container.innerHTML = createProductRowHtml(0, '', '', '', false);
        newProductRowCounter = 1;
        updateNewTotals();
        updateRemoveButtons('new');
    }
    function addNewProductRow() {
        const container = document.getElementById('new-products-container');
        container.insertAdjacentHTML('beforeend', createProductRowHtml(newProductRowCounter, '', '', '', false));
        newProductRowCounter++;
        updateNewTotals();
        updateRemoveButtons('new');
    }
    function removeNewProductRow(button) {
        const container = document.getElementById('new-products-container');
        if (container.childElementCount > 1) {
            const row = button.closest('.product-row');
            row.remove();
            updateNewTotals();
            updateRemoveButtons('new');
        } else {
            showFlashMessage('Cannot remove the last product row. A sale must have at least one product.', 'error');
        }
    }
    function updateNewTotals() {
        let totalWeight = 0;
        let totalQuantity = 0;

        document.querySelectorAll('#new-products-container .product-row').forEach(row => {
            const weightInput = row.querySelector('input[name="weight_kg[]"]');
            const quantityInput = row.querySelector('input[name="quantity[]"]');

            const weight = parseFloat(weightInput.value);
            const quantity = parseInt(quantityInput.value);

            if (!isNaN(weight) && weight > 0) {
                totalWeight += weight;
            }
            if (!isNaN(quantity) && quantity > 0) {
                totalQuantity += quantity;
            }
        });

        document.getElementById('new-total-weight').textContent = totalWeight.toFixed(2) + ' kg';
        document.getElementById('new-total-quantity').textContent = totalQuantity;

        const overallPricePerKgInput = document.getElementById('new-overall-price-per-kg');
        const overallPricePerKg = parseFloat(overallPricePerKgInput.value);
        let totalAmountDue = 0;
        if (!isNaN(totalWeight) && !isNaN(overallPricePerKg)) {
            totalAmountDue = totalWeight * overallPricePerKg;
        }
        document.getElementById('new-total-amount-due').textContent = '₹' + totalAmountDue.toFixed(2);
    }

    // --- Edit Sale Form Specific Functions (must be global for inline calls) ---
    let editProductRowCounter = 0; // Reset counter for edit form
    function loadEditProductRows(products) {
        const container = document.getElementById('edit-products-container');
        container.innerHTML = '';
        editProductRowCounter = 0;
        if (products.length === 0) {
            products.push({ bananaType: '', weightKg: '', quantity: '' });
        }
        products.forEach(product => {
            container.insertAdjacentHTML('beforeend', createProductRowHtml(editProductRowCounter, product.bananaType, product.weightKg, product.quantity, true));
            editProductRowCounter++;
        });
        updateEditTotals();
        updateRemoveButtons('edit');
    }
    function addEditProductRow() {
        const container = document.getElementById('edit-products-container');
        container.insertAdjacentHTML('beforeend', createProductRowHtml(editProductRowCounter, '', '', '', true));
        editProductRowCounter++;
        updateEditTotals();
        updateRemoveButtons('edit');
    }
    function removeEditProductRow(button) {
        const container = document.getElementById('edit-products-container');
        if (container.childElementCount > 1) {
            const row = button.closest('.product-row');
            row.remove();
            updateEditTotals();
            updateRemoveButtons('edit');
        } else {
            showFlashMessage('Cannot remove the last product row. A sale must have at least one product.', 'error');
        }
    }
    function updateEditTotals() {
        let totalWeight = 0;
        let totalQuantity = 0;

        document.querySelectorAll('#edit-products-container .product-row').forEach(row => {
            const weightInput = row.querySelector('input[name="weight_kg[]"]');
            const quantityInput = row.querySelector('input[name="quantity[]"]');

            const weight = parseFloat(weightInput.value);
            const quantity = parseInt(quantityInput.value);

            if (!isNaN(weight) && weight > 0) {
                totalWeight += weight;
            }
            if (!isNaN(quantity) && quantity > 0) {
                totalQuantity += quantity;
            }
        });

        document.getElementById('edit-total-weight').textContent = totalWeight.toFixed(2) + ' kg';
        document.getElementById('edit-total-quantity').textContent = totalQuantity;

        const overallPricePerKgInput = document.getElementById('edit-overall-price-per-kg');
        const overallPricePerKg = parseFloat(overallPricePerKgInput.value);
        let totalAmountDue = 0;
        if (!isNaN(totalWeight) && !isNaN(overallPricePerKg)) {
            totalAmountDue = totalWeight * overallPricePerKg;
        }
        document.getElementById('edit-total-amount-due').textContent = '₹' + totalAmountDue.toFixed(2);
    }


    // --- Core Application Functions (must be global for inline calls) ---

    // Render Sales List (FETCHES FROM FIREBASE)
    async function renderSalesList() {
        // Check if salesCollection is initialized. If not, Firebase initialization might have failed.
        if (!salesCollection) {
            console.error("Firestore salesCollection not initialized. Cannot render sales list.");
            // Display an error message to the user if the database is not ready.
            document.getElementById('sales-list-container').innerHTML = '<p class="text-red-600 text-center py-4">Database not ready. Please refresh the page or check your Firebase setup in the browser console.</p>';
            document.getElementById('total-sales-amount').textContent = '₹0.00';
            document.getElementById('total-amount-received').textContent = '₹0.00';
            document.getElementById('total-outstanding').textContent = '₹0.00';
            return;
        }

        const salesListContainer = document.getElementById('sales-list-container');
        salesListContainer.innerHTML = '<p class="text-gray-600 text-center py-4">Loading sales data...</p>';

        try {
            const snapshot = await salesCollection.orderBy('date', 'desc').get();
            const sales = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            if (sales.length === 0) {
                salesListContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No sales recorded yet. Add a new sale above!</p>';
                document.getElementById('total-sales-amount').textContent = '₹0.00';
                document.getElementById('total-amount-received').textContent = '₹0.00';
                document.getElementById('total-outstanding').textContent = '₹0.00';
                return;
            }

            let totalSalesAmount = 0;
            let totalAmountReceived = 0;
            let totalOutstanding = 0;

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden';
            table.innerHTML = `
                <thead class="bg-green-100">
                    <tr>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Bill No.</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Merchant</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total Weight (kg)</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total Quantity</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Overall Price/kg (₹)</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total (₹)</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Received (₹)</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Balance (₹)</th>
                        <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="sales-table-body">
                </tbody>
            `;
            salesListContainer.innerHTML = '';
            salesListContainer.appendChild(table);

            const salesTableBody = document.getElementById('sales-table-body');
            sales.forEach(sale => {
                totalSalesAmount += sale.totalAmount;
                totalAmountReceived += sale.amountReceived;
                totalOutstanding += sale.balanceDue;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.billNumber}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.date}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.merchantName}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.totalWeightKg.toFixed(2)}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.totalQuantity}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.overallPricePerKg.toFixed(2)}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">₹${sale.totalAmount.toFixed(2)}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-blue-600">₹${sale.amountReceived.toFixed(2)}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-bold ${sale.balanceDue > 0 ? 'text-red-600' : 'text-green-600'}">₹${sale.balanceDue.toFixed(2)}</td>
                    <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button onclick="openEditModal('${sale.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 text-xs sm:text-sm">
                                Edit
                            </button>
                            <button onclick="openPaymentModal('${sale.id}')" class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-xs sm:text-sm">
                                Payment
                            </button>
                            <button onclick="openBillModal('${sale.id}')" class="px-3 py-1 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-xs sm:text-sm">
                                Bill
                            </button>
                            <button onclick="openConfirmModal('delete', '${sale.id}')" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs sm:text-sm">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;
                salesTableBody.appendChild(row);
            });

            document.getElementById('total-sales-amount').textContent = `₹${totalSalesAmount.toFixed(2)}`;
            document.getElementById('total-amount-received').textContent = `₹${totalAmountReceived.toFixed(2)}`;
            document.getElementById('total-outstanding').textContent = `₹${totalOutstanding.toFixed(2)}`;

        } catch (error) {
            console.error("Error fetching sales: ", error);
            showFlashMessage('Error loading sales data. Please check your Firebase setup and network connection.', 'error');
            salesListContainer.innerHTML = '<p class="text-red-600 text-center py-4">Failed to load sales data.</p>';
        }
    }

    // --- Modal Functions (called by onclick and need db/salesCollection) ---

    async function openEditModal(saleId) {
        try {
            const docRef = salesCollection.doc(saleId);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                showFlashMessage('Sale not found for editing.', 'error');
                return;
            }
            const saleToEdit = { id: docSnap.id, ...docSnap.data() };

            document.getElementById('edit-sale-id').value = saleToEdit.id;
            document.getElementById('edit-sale-date').value = saleToEdit.date;
            document.getElementById('edit-merchant-name').value = saleToEdit.merchantName;
            document.getElementById('edit-overall-price-per-kg').value = saleToEdit.overallPricePerKg.toFixed(2);

            loadEditProductRows(saleToEdit.products || []);
            document.getElementById('edit-sale-modal').classList.remove('hidden');

        } catch (error) {
            console.error("Error opening edit modal: ", error);
            showFlashMessage('Error loading sale for edit. Please try again.', 'error');
        }
    }

    async function openPaymentModal(saleId) {
        try {
            const docRef = salesCollection.doc(saleId);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                showFlashMessage('Sale not found for payment.', 'error');
                return;
            }
            const saleToPay = { id: docSnap.id, ...docSnap.data() };

            document.getElementById('payment-sale-id').value = saleToPay.id;
            document.getElementById('payment-bill-number').textContent = saleToPay.billNumber;
            document.getElementById('payment-merchant-name').textContent = saleToPay.merchantName;
            document.getElementById('payment-total-amount').textContent = saleToPay.totalAmount.toFixed(2);
            document.getElementById('payment-balance-due').textContent = saleToPay.balanceDue.toFixed(2);
            document.getElementById('payment-amount-input').value = saleToPay.balanceDue.toFixed(2);

            document.getElementById('payment-modal').classList.remove('hidden');

        } catch (error) {
            console.error("Error opening payment modal: ", error);
            showFlashMessage('Error loading sale for payment. Please try again.', 'error');
        }
    }

    async function openBillModal(saleId) {
        try {
            const docRef = salesCollection.doc(saleId);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                showFlashMessage('Sale not found for bill view.', 'error');
                return;
            }
            const saleToView = { id: docSnap.id, ...docSnap.data() };

            document.getElementById('bill-bill-number').textContent = saleToView.billNumber;
            document.getElementById('bill-date').textContent = saleToView.date;
            document.getElementById('bill-merchant-name').textContent = saleToView.merchantName;

            const productsTbody = document.getElementById('bill-products-tbody');
            productsTbody.innerHTML = '';

            saleToView.products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.bananaType}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.weightKg.toFixed(2)}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.quantity}</td>
                    <td class="border border-gray-300 px-4 py-2 text-right text-sm text-gray-800">
                        ${(product.weightKg * saleToView.overallPricePerKg).toFixed(2)}
                    </td>
                `;
                productsTbody.appendChild(row);
            });

            document.getElementById('bill-total-weight').textContent = saleToView.totalWeightKg.toFixed(2);
            document.getElementById('bill-total-quantity').textContent = saleToView.totalQuantity;
            document.getElementById('bill-overall-price-per-kg').textContent = saleToView.overallPricePerKg.toFixed(2);
            document.getElementById('bill-total-amount').textContent = saleToView.totalAmount.toFixed(2);
            document.getElementById('bill-amount-received').textContent = saleToView.amountReceived.toFixed(2);
            document.getElementById('bill-balance-due').textContent = saleToView.balanceDue.toFixed(2);

            document.getElementById('bill-view-modal').classList.remove('hidden');

        } catch (error) {
            console.error("Error opening bill modal: ", error);
            showFlashMessage('Error loading bill data. Please try again.', 'error');
        }
    }

    // Confirmation Modal Logic (for Delete)
    let currentConfirmAction = null;

    function openConfirmModal(actionType, saleId) {
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessageElement = document.getElementById('confirm-message');

        if (actionType === 'delete') {
            confirmMessageElement.textContent = "Are you sure you want to delete this sale record? This action cannot be undone.";
            currentConfirmAction = async () => {
                try {
                    await salesCollection.doc(saleId).delete();
                    showFlashMessage('Sale deleted successfully!', 'success');
                    confirmModal.classList.add('hidden');
                    renderSalesList();
                } catch (error) {
                    console.error("Error deleting sale: ", error);
                    showFlashMessage('Error deleting sale. Please try again.', 'error');
                    confirmModal.classList.add('hidden');
                }
            };
        }

        confirmModal.classList.remove('hidden');
    }


    // --- Firebase Initialization and Main Event Listeners (on DOMContentLoaded) ---
    // This block runs once the HTML document is fully loaded.
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration ---
        // IMPORTANT: This has been updated with your provided Firebase config.
        const firebaseConfig = {
            apiKey: "AIzaSyDNWaOPTn1GiT8zAWFfXxiYuA-depTisCc",
            authDomain: "my-banana-sales-app.firebaseapp.com",
            projectId: "my-banana-sales-app",
            storageBucket: "my-banana-sales-app.firebasestorage.app",
            messagingSenderId: "461621717926",
            appId: "1:461621717926:web:078f5f43bb35bcce93fd67",
            measurementId: "G-PTW713Z5VN"
        };

        // Log the firebaseConfig for debugging
        console.log("Firebase Config:", firebaseConfig);

        // Initialize Firebase and setup database references
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(); // Assign to global db variable
            salesCollection = db.collection('sales'); // Assign to global salesCollection variable
            console.log("Firebase initialized successfully.");

            // Initial render of sales data
            renderSalesList();
            addInitialNewProductRow(); // For the 'Add New Sale' form initially

        } catch (initError) {
            console.error("Firebase Initialization Error:", initError);
            document.getElementById('sales-list-container').innerHTML = '<p class="text-red-600 text-center py-4">Error initializing Firebase. Please check your console for details and ensure your `firebaseConfig` is correct.</p>';
            showFlashMessage('Application initialization failed. Check console for Firebase config errors.', 'error');
            return; // Stop execution if Firebase fails to initialize
        }

        // --- Event Listeners for Modals and Forms ---
        // These are set up AFTER Firebase is initialized and the DOM is ready.

        // Add Sale Modal
        document.getElementById('add-sale-btn').addEventListener('click', () => {
            document.getElementById('new-sale-date').value = '';
            document.getElementById('new-merchant-name').value = '';
            document.getElementById('new-overall-price-per-kg').value = '';
            addInitialNewProductRow();
            document.getElementById('add-sale-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-add-sale-btn').addEventListener('click', () => {
            document.getElementById('add-sale-modal').classList.add('hidden');
        });
        document.getElementById('add-new-product-row-btn').addEventListener('click', addNewProductRow);
        document.getElementById('new-overall-price-per-kg').addEventListener('input', updateNewTotals);
        document.getElementById('add-sale-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            try {
                const newSaleDate = document.getElementById('new-sale-date').value;
                const newMerchantName = document.getElementById('new-merchant-name').value;
                const newOverallPricePerKg = parseFloat(document.getElementById('new-overall-price-per-kg').value);

                const productRows = document.querySelectorAll('#new-products-container .product-row');
                const products = [];
                let totalWeightKg = 0;
                let totalQuantity = 0;

                let isValid = true;
                if (productRows.length === 0) {
                    showFlashMessage('Please add at least one banana product.', 'error');
                    isValid = false;
                }

                productRows.forEach(row => {
                    const bananaType = row.querySelector('select[name="banana_type[]"]').value;
                    const weightInput = row.querySelector('input[name="weight_kg[]"]');
                    const quantityInput = row.querySelector('input[name="quantity[]"]');

                    const weight = parseFloat(weightInput.value);
                    const quantity = parseInt(quantityInput.value);

                    if (!bananaType || isNaN(weight) || weight <= 0 || isNaN(quantity) || quantity <= 0) {
                        showFlashMessage('Please fill all product fields with valid positive numbers for each entry.', 'error');
                        isValid = false;
                    }
                    products.push({ bananaType, weightKg: weight, quantity: quantity });
                    totalWeightKg += weight;
                    totalQuantity += quantity;
                });

                if (!isValid) return;

                if (isNaN(newOverallPricePerKg) || newOverallPricePerKg <= 0) {
                    showFlashMessage('Please enter a valid positive Overall Price per kg.', 'error');
                    return;
                }

                const totalAmount = totalWeightKg * newOverallPricePerKg;

                const newSale = {
                    billNumber: `BILL-${Date.now()}`,
                    date: newSaleDate,
                    merchantName: newMerchantName,
                    products: products,
                    totalWeightKg: totalWeightKg,
                    totalQuantity: totalQuantity,
                    overallPricePerKg: newOverallPricePerKg,
                    totalAmount: totalAmount,
                    amountReceived: 0,
                    balanceDue: totalAmount
                };

                await salesCollection.add(newSale);
                showFlashMessage('Sale added successfully!', 'success');

                document.getElementById('add-sale-modal').classList.add('hidden');
                document.getElementById('add-sale-form').reset();
                renderSalesList();

            } catch (error) {
                console.error("Error adding sale: ", error);
                showFlashMessage('Error adding sale. Please try again.', 'error');
            }
        });

        // Edit Sale Modal
        document.getElementById('add-edit-product-row-btn').addEventListener('click', addEditProductRow);
        document.getElementById('edit-overall-price-per-kg').addEventListener('input', updateEditTotals);
        document.getElementById('cancel-edit-sale-btn').addEventListener('click', () => {
            document.getElementById('edit-sale-modal').classList.add('hidden');
        });
        document.getElementById('edit-sale-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            try {
                const saleId = document.getElementById('edit-sale-id').value;
                const updatedDate = document.getElementById('edit-sale-date').value;
                const updatedMerchant = document.getElementById('edit-merchant-name').value;
                const updatedOverallPricePerKg = parseFloat(document.getElementById('edit-overall-price-per-kg').value);

                const productRows = document.querySelectorAll('#edit-products-container .product-row');
                const updatedProducts = [];
                let updatedTotalWeightKg = 0;
                let updatedTotalQuantity = 0;

                let isValid = true;
                if (productRows.length === 0) {
                    showFlashMessage('Please add at least one banana product for editing.', 'error');
                    isValid = false;
                }

                productRows.forEach(row => {
                    const bananaType = row.querySelector('select[name="banana_type[]"]').value;
                    const weightInput = row.querySelector('input[name="weight_kg[]"]');
                    const quantityInput = row.querySelector('input[name="quantity[]"]');

                    const weight = parseFloat(weightInput.value);
                    const quantity = parseInt(quantityInput.value);

                    if (!bananaType || isNaN(weight) || weight <= 0 || isNaN(quantity) || quantity <= 0) {
                        showFlashMessage('Please fill all product fields with valid positive numbers for each entry during editing.', 'error');
                        isValid = false;
                    }
                    updatedProducts.push({ bananaType, weightKg: weight, quantity: quantity });
                    updatedTotalWeightKg += weight;
                    updatedTotalQuantity += quantity;
                });

                if (!isValid) return;

                if (isNaN(updatedOverallPricePerKg) || updatedOverallPricePerKg <= 0) {
                    showFlashMessage('Please enter a valid positive Overall Price per kg for editing.', 'error');
                    return;
                }

                const updatedTotalAmount = updatedTotalWeightKg * updatedOverallPricePerKg;

                const currentSaleDoc = await salesCollection.doc(saleId).get();
                if (!currentSaleDoc.exists) {
                    showFlashMessage('Error: Sale not found for update.', 'error');
                    return;
                }
                const currentSaleData = currentSaleDoc.data();
                const currentAmountReceived = currentSaleData.amountReceived || 0;

                let updatedBalanceDue = updatedTotalAmount - currentAmountReceived;
                if (updatedBalanceDue < 0) {
                    updatedBalanceDue = 0;
                }

                const updateData = {
                    date: updatedDate,
                    merchantName: updatedMerchant,
                    products: updatedProducts,
                    totalWeightKg: updatedTotalWeightKg,
                    totalQuantity: updatedTotalQuantity,
                    overallPricePerKg: updatedOverallPricePerKg,
                    totalAmount: updatedTotalAmount,
                    balanceDue: updatedBalanceDue
                };

                await salesCollection.doc(saleId).update(updateData);
                showFlashMessage('Sale updated successfully!', 'success');

                document.getElementById('edit-sale-modal').classList.add('hidden');
                renderSalesList();

            } catch (error) {
                console.error("Error updating sale: ", error);
                showFlashMessage('Error updating sale. Please try again.', 'error');
            }
        });

        // Payment Modal
        document.getElementById('cancel-payment-btn').addEventListener('click', () => {
            document.getElementById('payment-modal').classList.add('hidden');
        });
        document.getElementById('payment-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            try {
                const saleId = document.getElementById('payment-sale-id').value;
                const paymentAmount = parseFloat(document.getElementById('payment-amount-input').value);

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showFlashMessage('Please enter a valid positive payment amount.', 'error');
                    return;
                }

                const docRef = salesCollection.doc(saleId);
                const docSnap = await docRef.get();
                if (!docSnap.exists) {
                    showFlashMessage('Error: Sale not found for payment update.', 'error');
                    return;
                }
                const currentSaleData = docSnap.data();

                let newAmountReceived = (currentSaleData.amountReceived || 0) + paymentAmount;
                let newBalanceDue = currentSaleData.totalAmount - newAmountReceived;
                if (newBalanceDue < 0) {
                    newBalanceDue = 0;
                }

                await docRef.update({
                    amountReceived: newAmountReceived,
                    balanceDue: newBalanceDue
                });

                showFlashMessage('Payment recorded successfully!', 'success');
                document.getElementById('payment-modal').classList.add('hidden');
                renderSalesList();

            } catch (error) {
                console.error("Error updating payment: ", error);
                showFlashMessage('Error updating payment. Please try again.', 'error');
            }
        });

        // Bill View Modal
        document.getElementById('close-bill-btn').addEventListener('click', () => {
            document.getElementById('bill-view-modal').classList.add('hidden');
        });
        document.getElementById('print-bill-btn').addEventListener('click', () => {
            window.print();
        });

        // Confirmation Modal (for Delete)
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            currentConfirmAction = null;
        });
        document.getElementById('execute-confirm-btn').addEventListener('click', () => {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
        });

    }); // End of DOMContentLoaded
</script>
