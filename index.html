<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASPG Banana Sales Software</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .flash-message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: none; /* Hidden by default */
        }
        .flash-message.success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .flash-message.error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensure modal is on top */
        }
        /* Modal Content */
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 48rem; /* Equivalent to max-w-2xl or max-w-4xl for edit */
            max-height: 90vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling for long forms */
        }
        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #bill-content, #bill-content * {
                visibility: visible;
            }
            #bill-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                box-sizing: border-box;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="flash-message-container" class="flash-message"></div>

        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8 mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-green-700 mb-6">ASPG Banana Sales Software</h1>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-green-50 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-lg font-semibold text-green-800">Total Sales</h2>
                    <p id="total-sales-amount" class="text-2xl font-bold text-green-600">₹0.00</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-lg font-semibold text-blue-800">Amount Received</h2>
                    <p id="total-amount-received" class="text-2xl font-bold text-blue-600">₹0.00</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-lg font-semibold text-yellow-800">Outstanding Balance</h2>
                    <p id="total-outstanding" class="text-2xl font-bold text-yellow-600">₹0.00</p>
                </div>
            </div>

            <div class="text-center mb-6">
                <button id="add-sale-btn" class="inline-block px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Add New Sale
                </button>
            </div>

            <div class="p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-green-700 mb-4">All Sales Records</h2>
                <div id="sales-list-container" class="overflow-x-auto">
                    <p class="text-gray-600 text-center py-4">Loading sales data...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modals-container">
        <div id="add-sale-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-4xl">
                <h2 class="text-2xl font-semibold text-green-700 mb-6 text-center">Add New Sale</h2>
                <form id="add-sale-form" class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-sale-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input
                                type="date"
                                id="new-sale-date"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                required
                            />
                        </div>
                        <div>
                            <label for="new-merchant-name" class="block text-sm font-medium text-gray-700">Merchant Name</label>
                            <input
                                type="text"
                                id="new-merchant-name"
                                placeholder="e.g., Green Grocers"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                required
                            />
                        </div>
                    </div>

                    <div id="new-products-container" class="mt-4 border-t border-gray-200 pt-4 mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Banana Products</h3>
                        </div>
                    <button type="button" id="add-new-product-row-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm mt-2">
                        Add Another Product
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gross Weight (kg)</label>
                            <p id="new-total-weight" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                0.00 kg
                            </p>
                        </div>
                        <div>
                            <label for="new-wastage-weight-kg" class="block text-sm font-medium text-gray-700">Wastage (Stem) (kg)</label>
                            <input
                                type="number"
                                id="new-wastage-weight-kg"
                                placeholder="e.g., 5"
                                step="0.01"
                                value="0"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                oninput="updateNewTotals()"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Net Billed Weight (kg)</label>
                            <p id="new-net-billed-weight" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-blue-700">
                                0.00 kg
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Total Quantity</label>
                            <p id="new-total-quantity" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                0
                            </p>
                        </div>
                        <div class="md:col-span-2">
                            <label for="new-overall-price-per-kg" class="block text-sm font-medium text-gray-700">Overall Price per kg (₹)</label>
                            <input
                                type="number"
                                id="new-overall-price-per-kg"
                                placeholder="e.g., 25"
                                step="0.01"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                required
                                oninput="updateNewTotals()"
                            />
                        </div>
                    </div>

                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700">Total Amount Due (₹)</label>
                        <p id="new-total-amount-due" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-green-700">
                            ₹0.00
                        </p>
                    </div>

                    <div class="col-span-full flex justify-end mt-6 space-x-3">
                        <button type="button" id="cancel-add-sale-btn" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Cancel
                        </button>
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Add Sale
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="edit-sale-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-4xl">
                <h2 class="text-2xl font-semibold text-green-700 mb-6 text-center">Edit Sale Record</h2>
                <form id="edit-sale-form" class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="edit-sale-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-sale-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input
                                type="date"
                                id="edit-sale-date"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                required
                            />
                        </div>
                        <div>
                            <label for="edit-merchant-name" class="block text-sm font-medium text-gray-700">Merchant Name</label>
                            <input
                                type="text"
                                id="edit-merchant-name"
                                placeholder="e.g., Green Grocers"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                required
                            />
                        </div>
                    </div>

                    <div id="edit-products-container" class="mt-4 border-t border-gray-200 pt-4 mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Banana Products</h3>
                        </div>
                    <button type="button" id="add-edit-product-row-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm mt-2">
                        Add Another Product
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gross Weight (kg)</label>
                            <p id="edit-total-weight" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                0.00 kg
                            </p>
                        </div>
                        <div>
                            <label for="edit-wastage-weight-kg" class="block text-sm font-medium text-gray-700">Wastage (Stem) (kg)</label>
                            <input
                                type="number"
                                id="edit-wastage-weight-kg"
                                placeholder="e.g., 5"
                                step="0.01"
                                value="0"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                oninput="updateEditTotals()"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Net Billed Weight (kg)</label>
                            <p id="edit-net-billed-weight" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-blue-700">
                                0.00 kg
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Total Quantity</label>
                            <p id="edit-total-quantity" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                0
                            </p>
                        </div>
                        <div class="md:col-span-2">
                            <label for="edit-overall-price-per-kg" class="block text-sm font-medium text-gray-700">Overall Price per kg (₹)</label>
                            <input
                                type="number"
                                id="edit-overall-price-per-kg"
                                placeholder="e.g., 25"
                                step="0.01"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                required
                                oninput="updateEditTotals()"
                            />
                        </div>
                    </div>

                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700">New Total Amount Due (₹)</label>
                        <p id="edit-total-amount-due" class="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-green-700">
                            ₹0.00
                        </p>
                    </div>

                    <div class="col-span-full flex justify-end mt-6 space-x-3">
                        <button type="button" id="cancel-edit-sale-btn" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Cancel
                        </button>
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="payment-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-md">
                <h2 class="text-xl font-semibold text-green-700 mb-4">Record Payment</h2>
                <p class="mb-2 text-lg text-gray-700"><strong>Bill Number:</strong> <span id="payment-bill-number"></span></p>
                <p class="mb-2 text-lg text-gray-700"><strong>Merchant:</strong> <span id="payment-merchant-name"></span></p>
                <p class="mb-2 text-lg text-gray-700"><strong>Total Amount:</strong> ₹<span id="payment-total-amount"></span></p>
                <p class="mb-4 text-lg text-gray-700"><strong>Current Balance Due:</strong> ₹<span id="payment-balance-due"></span></p>

                <form id="payment-form">
                    <input type="hidden" id="payment-sale-id">
                    <div class="mb-6">
                        <label for="payment-amount-input" class="block text-sm font-medium text-gray-700">Amount to Receive (₹)</label>
                        <input
                            type="number"
                            id="payment-amount-input"
                            step="0.01"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                            required
                        />
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-payment-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Update Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="bill-view-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-2xl">
                <div id="bill-content" class="p-4 border border-gray-300 rounded-md">
                    <h2 class="text-2xl font-bold text-center text-green-800 mb-4">Banana Sales Bill</h2>
                    <div class="mb-4 text-sm">
                        <p><strong>Bill Number:</strong> <span id="bill-bill-number"></span></p>
                        <p><strong>Date:</strong> <span id="bill-date"></span></p>
                        <p><strong>Seller:</strong> ALPHONSE N</p>
                        <p><strong>Address:</strong> Nagercoil Pampanvilai Anandanadarkudi Road</p>
                        <p><strong>Contact:</strong> +91 9443391054</p>
                    </div>
                    <div class="mb-6">
                        <p class="text-lg font-semibold mb-2">Bill To:</p>
                        <p class="text-xl font-bold text-gray-800" id="bill-merchant-name"></p>
                    </div>

                    <table class="min-w-full mb-6 border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Description (Banana Type)</th>
                                <th class="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Weight (kg)</th>
                                <th class="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Quantity</th>
                                <th class="border border-gray-300 px-4 py-2 text-right text-sm font-medium text-gray-700">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody id="bill-products-tbody">
                            </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Gross Weight:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold"><span id="bill-gross-weight"></span> kg</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Wastage (Stem) Weight:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold text-red-600">
                                    - <span id="bill-wastage-weight"></span> kg
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Net Billed Weight:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold text-blue-700">
                                    <span id="bill-net-billed-weight"></span> kg
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Total Quantity:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold"><span id="bill-total-quantity"></span></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Overall Price/kg:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold">₹<span id="bill-overall-price-per-kg"></span></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Total Amount:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold text-green-700">₹<span id="bill-total-amount"></span></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Amount Received:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold text-blue-700">₹<span id="bill-amount-received"></span></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border border-gray-300 px-4 py-2 text-right font-semibold">Balance Due:</td>
                                <td class="border border-gray-300 px-4 py-2 text-right font-bold text-red-700">₹<span id="bill-balance-due"></span></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="text-sm mt-6 text-center">
                        <p>Thank you for your business!</p>
                        <p class="mt-4">_________________________</p>
                        <p>Signature</p>
                    </div>
                </div>
                <div class="text-center mt-6 no-print">
                    <button id="print-bill-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        Print Bill
                    </button>
                    <button id="close-bill-btn" class="px-6 py-3 ml-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-offset-2 transition duration-150 ease-in-out">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <div id="confirm-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-sm">
                <h2 class="text-xl font-semibold text-red-700 mb-4">Confirm Action</h2>
                <p id="confirm-message" class="mb-6 text-gray-700"></p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-confirm-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" id="execute-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Global Firebase References (declared here, assigned after init) ---
        // These need to be accessible by functions that are called by onclick/oninput handlers.
        let db;
        let salesCollection;
        let billCounterDocRef; // Reference to the bill counter document

        // --- GLOBAL UTILITIES AND CONSTANTS (Accessible throughout the script) ---
        const bananaTypes = ["Red Banana", "Robusta", "Matti", "Athan"];

        function showFlashMessage(message, type) {
            const flashContainer = document.getElementById('flash-message-container');
            flashContainer.textContent = message;
            flashContainer.className = `flash-message ${type} block`;
            setTimeout(() => {
                flashContainer.className = `flash-message ${type} hidden`;
            }, 5000); // Hide after 5 seconds
        }

        // --- Product Row HTML Generation (used by both Add/Edit modals) ---
        function createProductRowHtml(index, bananaType = '', weightKg = '', quantity = '', isEdit = false) {
            const idPrefix = isEdit ? 'edit-' : 'new-';
            // Ensure oninput calls correct total update function
            const onInputChange = isEdit ? 'updateEditTotals()' : 'updateNewTotals()';

            const removeButtonHtml = `
                <div class="flex justify-end sm:justify-start">
                    <button type="button" onclick="${isEdit ? 'removeEditProductRow(this)' : 'removeNewProductRow(this)'}" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">
                        Remove
                    </button>
                </div>`;

            return `
                <div class="product-row grid grid-cols-1 sm:grid-cols-4 gap-3 mb-3 p-3 bg-gray-50 rounded-md shadow-sm items-end" id="product-row-${idPrefix}${index}">
                    <div>
                        <label for="${idPrefix}banana_type-${index}" class="block text-sm font-medium text-gray-700">Banana Type</label>
                        <select
                            id="${idPrefix}banana_type-${index}"
                            name="banana_type[]"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                            required
                        >
                            <option value="">Select Type</option>
                            ${bananaTypes.map(type => `<option value="${type}" ${bananaType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="${idPrefix}weight_kg-${index}" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                        <input
                            type="number"
                            id="${idPrefix}weight_kg-${index}"
                            name="weight_kg[]"
                            value="${weightKg}"
                            placeholder="e.g., 100"
                            step="0.01"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                            required
                            oninput="${onInputChange}"
                        />
                    </div>
                    <div>
                        <label for="${idPrefix}quantity-${index}" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input
                            type="number"
                            id="${idPrefix}quantity-${index}"
                            name="quantity[]"
                            value="${quantity}"
                            placeholder="e.g., 50"
                            step="1"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                            required
                            oninput="${onInputChange}"
                        />
                    </div>
                    ${removeButtonHtml}
                </div>
            `;
        }

        // Function to update visibility of remove buttons based on row count
        function updateRemoveButtons(formType) {
            const containerId = formType === 'new' ? 'new-products-container' : 'edit-products-container';
            const container = document.getElementById(containerId);
            const productRows = container.querySelectorAll('.product-row');

            productRows.forEach(row => {
                const removeButtonDiv = row.querySelector('.flex.justify-end.sm\\:justify-start');
                if (removeButtonDiv) {
                    const removeButton = removeButtonDiv.querySelector('button');
                    if (removeButton) {
                        if (productRows.length <= 1) {
                            removeButton.style.display = 'none'; // Hide if only one row
                        } else {
                            removeButton.style.display = 'inline-block'; // Show if more than one row
                        }
                    }
                }
            });
        }

        // --- New Sale Form Specific Functions (must be global for inline calls) ---
        let newProductRowCounter = 0; // Reset counter for new form
        function addInitialNewProductRow() {
            const container = document.getElementById('new-products-container');
            container.innerHTML = createProductRowHtml(0, '', '', '', false);
            newProductRowCounter = 1;
            document.getElementById('new-wastage-weight-kg').value = '0'; // Reset wastage
            document.getElementById('new-overall-price-per-kg').value = ''; // Clear overall price
            updateNewTotals();
            updateRemoveButtons('new');
        }
        function addNewProductRow() {
            const container = document.getElementById('new-products-container');
            container.insertAdjacentHTML('beforeend', createProductRowHtml(newProductRowCounter, '', '', '', false));
            newProductRowCounter++;
            updateNewTotals();
            updateRemoveButtons('new');
        }
        function removeNewProductRow(button) {
            const container = document.getElementById('new-products-container');
            if (container.childElementCount > 1) {
                const row = button.closest('.product-row');
                row.remove();
                updateNewTotals();
                updateRemoveButtons('new');
            } else {
                showFlashMessage('Cannot remove the last product row. A sale must have at least one product.', 'error');
            }
        }
        function updateNewTotals() {
            let totalGrossWeight = 0; // Renamed to gross weight
            let totalQuantity = 0;

            document.querySelectorAll('#new-products-container .product-row').forEach(row => {
                const weightInput = row.querySelector('input[name="weight_kg[]"]');
                const quantityInput = row.querySelector('input[name="quantity[]"]');

                const weight = parseFloat(weightInput.value);
                const quantity = parseInt(quantityInput.value);

                if (!isNaN(weight) && weight > 0) {
                    totalGrossWeight += weight;
                }
                if (!isNaN(quantity) && quantity > 0) {
                    totalQuantity += quantity;
                }
            });

            const wastageWeightInput = document.getElementById('new-wastage-weight-kg');
            let wastageWeight = parseFloat(wastageWeightInput.value) || 0; // Get wastage, default to 0

            let netBilledWeight = totalGrossWeight - wastageWeight;
            if (netBilledWeight < 0) { // Ensure net weight doesn't go negative
                netBilledWeight = 0;
                // Optionally, adjust wastage to not exceed gross weight if desired for user input
                // wastageWeightInput.value = totalGrossWeight.toFixed(2);
                // wastageWeight = totalGrossWeight;
            }

            document.getElementById('new-total-weight').textContent = totalGrossWeight.toFixed(2) + ' kg'; // This is gross
            // document.getElementById('new-wastage-weight-kg').value = wastageWeight.toFixed(2); // Keep value updated if auto-adjusted
            document.getElementById('new-net-billed-weight').textContent = netBilledWeight.toFixed(2) + ' kg'; // Display net
            document.getElementById('new-total-quantity').textContent = totalQuantity;

            const overallPricePerKgInput = document.getElementById('new-overall-price-per-kg');
            const overallPricePerKg = parseFloat(overallPricePerKgInput.value);
            let totalAmountDue = 0;
            // Calculate total amount based on NET billed weight
            if (!isNaN(netBilledWeight) && !isNaN(overallPricePerKg)) {
                totalAmountDue = netBilledWeight * overallPricePerKg;
            }
            document.getElementById('new-total-amount-due').textContent = '₹' + totalAmountDue.toFixed(2);
        }

        // --- Edit Sale Form Specific Functions (must be global for inline calls) ---
        let editProductRowCounter = 0; // Reset counter for edit form
        function loadEditProductRows(products) {
            const container = document.getElementById('edit-products-container');
            container.innerHTML = '';
            editProductRowCounter = 0;
            if (products.length === 0) {
                products.push({ bananaType: '', weightKg: '', quantity: '' });
            }
            products.forEach(product => {
                container.insertAdjacentHTML('beforeend', createProductRowHtml(editProductRowCounter, product.bananaType, product.weightKg, product.quantity, true));
                editProductRowCounter++;
            });
            updateEditTotals();
            updateRemoveButtons('edit');
        }
        function addEditProductRow() {
            const container = document.getElementById('edit-products-container');
            container.insertAdjacentHTML('beforeend', createProductRowHtml(editProductRowCounter, '', '', '', true));
            editProductRowCounter++;
            updateEditTotals();
            updateRemoveButtons('edit');
        }
        function removeEditProductRow(button) {
            const container = document.getElementById('edit-products-container');
            if (container.childElementCount > 1) {
                const row = button.closest('.product-row');
                row.remove();
                updateEditTotals();
                updateRemoveButtons('edit');
            } else {
                showFlashMessage('Cannot remove the last product row. A sale must have at least one product.', 'error');
            }
        }
        function updateEditTotals() {
            let totalGrossWeight = 0; // Renamed to gross weight
            let totalQuantity = 0;

            document.querySelectorAll('#edit-products-container .product-row').forEach(row => {
                const weightInput = row.querySelector('input[name="weight_kg[]"]');
                const quantityInput = row.querySelector('input[name="quantity[]"]');

                const weight = parseFloat(weightInput.value);
                const quantity = parseInt(quantityInput.value);

                if (!isNaN(weight) && weight > 0) {
                    totalGrossWeight += weight;
                }
                if (!isNaN(quantity) && quantity > 0) {
                    totalQuantity += quantity;
                }
            });

            const wastageWeightInput = document.getElementById('edit-wastage-weight-kg');
            let wastageWeight = parseFloat(wastageWeightInput.value) || 0; // Get wastage, default to 0

            let netBilledWeight = totalGrossWeight - wastageWeight;
            if (netBilledWeight < 0) { // Ensure net weight doesn't go negative
                netBilledWeight = 0;
                // Optionally, adjust wastage to not exceed gross weight if desired for user input
                // wastageWeightInput.value = totalGrossWeight.toFixed(2);
                // wastageWeight = totalGrossWeight;
            }

            document.getElementById('edit-total-weight').textContent = totalGrossWeight.toFixed(2) + ' kg'; // This is gross
            // document.getElementById('edit-wastage-weight-kg').value = wastageWeight.toFixed(2); // Keep value updated if auto-adjusted
            document.getElementById('edit-net-billed-weight').textContent = netBilledWeight.toFixed(2) + ' kg'; // Display net
            document.getElementById('edit-total-quantity').textContent = totalQuantity;

            const overallPricePerKgInput = document.getElementById('edit-overall-price-per-kg');
            const overallPricePerKg = parseFloat(overallPricePerKgInput.value);
            let totalAmountDue = 0;
            // Calculate total amount based on NET billed weight
            if (!isNaN(netBilledWeight) && !isNaN(overallPricePerKg)) {
                totalAmountDue = netBilledWeight * overallPricePerKg;
            }
            document.getElementById('edit-total-amount-due').textContent = '₹' + totalAmountDue.toFixed(2);
        }

        // Function to get and increment the bill number from Firestore
        async function getAndIncrementBillNumber() {
            try {
                const docSnap = await billCounterDocRef.get();
                let currentNumber = 1; // Default starting number

                if (docSnap.exists) {
                    currentNumber = (docSnap.data().currentNumber || 0) + 1;
                }

                await billCounterDocRef.set({ currentNumber: currentNumber });
                return currentNumber;
            } catch (error) {
                console.error("Error getting or incrementing bill number:", error);
                showFlashMessage('Error generating bill number. Please try again.', 'error');
                return null; // Indicate failure
            }
        }


        // --- Core Application Functions (must be global for inline calls) ---

        // Render Sales List (FETCHES FROM FIREBASE)
        async function renderSalesList() {
            // Check if salesCollection is initialized. If not, Firebase initialization might have failed.
            if (!salesCollection) {
                console.error("Firestore salesCollection not initialized. Cannot render sales list.");
                // Display an error message to the user if the database is not ready.
                document.getElementById('sales-list-container').innerHTML = '<p class="text-red-600 text-center py-4">Database not ready. Please refresh the page or check your Firebase setup in the browser console.</p>';
                document.getElementById('total-sales-amount').textContent = '₹0.00';
                document.getElementById('total-amount-received').textContent = '₹0.00';
                document.getElementById('total-outstanding').textContent = '₹0.00';
                return;
            }

            const salesListContainer = document.getElementById('sales-list-container');
            salesListContainer.innerHTML = '<p class="text-gray-600 text-center py-4">Loading sales data...</p>';

            try {
                const snapshot = await salesCollection.orderBy('date', 'desc').get();
                const sales = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                if (sales.length === 0) {
                    salesListContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No sales recorded yet. Add a new sale above!</p>';
                    document.getElementById('total-sales-amount').textContent = '₹0.00';
                    document.getElementById('total-amount-received').textContent = '₹0.00';
                    document.getElementById('total-outstanding').textContent = '₹0.00';
                    return;
                }

                let totalSalesAmount = 0;
                let totalAmountReceived = 0;
                let totalOutstanding = 0;

                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden';
                table.innerHTML = `
                    <thead class="bg-green-100">
                        <tr>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Bill No.</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Merchant</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Gross Weight (kg)</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Net Weight (kg)</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total Quantity</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Overall Price/kg (₹)</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total (₹)</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Received (₹)</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Balance (₹)</th>
                            <th class="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="sales-table-body">
                    </tbody>
                `;
                salesListContainer.innerHTML = '';
                salesListContainer.appendChild(table);

                const salesTableBody = document.getElementById('sales-table-body');
                sales.forEach(sale => {
                    totalSalesAmount += sale.totalAmount;
                    totalAmountReceived += sale.amountReceived;
                    totalOutstanding += sale.balanceDue;

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.billNumber}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.date}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.merchantName}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${(sale.totalWeightKg || 0).toFixed(2)}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${(sale.netWeightKg || 0).toFixed(2)}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.totalQuantity}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">${sale.overallPricePerKg.toFixed(2)}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">₹${sale.totalAmount.toFixed(2)}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-blue-600">₹${sale.amountReceived.toFixed(2)}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-bold ${sale.balanceDue > 0 ? 'text-red-600' : 'text-green-600'}">₹${sale.balanceDue.toFixed(2)}</td>
                        <td class="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <button onclick="openEditModal('${sale.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 text-xs sm:text-sm">
                                    Edit
                                </button>
                                <button onclick="openPaymentModal('${sale.id}')" class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-xs sm:text-sm">
                                    Payment
                                </button>
                                <button onclick="openBillModal('${sale.id}')" class="px-3 py-1 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-xs sm:text-sm">
                                    Bill
                                </button>
                                <button onclick="openConfirmModal('delete', '${sale.id}')" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs sm:text-sm">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                salesTableBody.appendChild(row);
            });

            document.getElementById('total-sales-amount').textContent = `₹${totalSalesAmount.toFixed(2)}`;
            document.getElementById('total-amount-received').textContent = `₹${totalAmountReceived.toFixed(2)}`;
            document.getElementById('total-outstanding').textContent = `₹${totalOutstanding.toFixed(2)}`;

        } catch (error) {
            console.error("Error fetching sales: ", error);
            showFlashMessage('Error loading sales data. Please check your Firebase setup and network connection.', 'error');
            salesListContainer.innerHTML = '<p class="text-red-600 text-center py-4">Failed to load sales data.</p>';
        }
    }

    // --- Modal Functions (called by onclick and need db/salesCollection) ---

    async function openEditModal(saleId) {
        try {
            const docRef = salesCollection.doc(saleId);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                showFlashMessage('Sale not found for editing.', 'error');
                return;
            }
            const saleToEdit = { id: docSnap.id, ...docSnap.data() };

            document.getElementById('edit-sale-id').value = saleToEdit.id;
            document.getElementById('edit-sale-date').value = saleToEdit.date;
            document.getElementById('edit-merchant-name').value = saleToEdit.merchantName;
            document.getElementById('edit-overall-price-per-kg').value = saleToEdit.overallPricePerKg.toFixed(2);
            // Load wastage weight, default to 0 if not present (for old sales)
            document.getElementById('edit-wastage-weight-kg').value = (saleToEdit.wastageWeightKg || 0).toFixed(2);


            loadEditProductRows(saleToEdit.products || []); // This also calls updateEditTotals()
            document.getElementById('edit-sale-modal').classList.remove('hidden');

        } catch (error) {
            console.error("Error opening edit modal: ", error);
            showFlashMessage('Error loading sale for edit. Please try again.', 'error');
        }
    }

    async function openPaymentModal(saleId) {
        try {
            const docRef = salesCollection.doc(saleId);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                showFlashMessage('Sale not found for payment.', 'error');
                return;
            }
            const saleToPay = { id: docSnap.id, ...docSnap.data() };

            document.getElementById('payment-sale-id').value = saleToPay.id;
            document.getElementById('payment-bill-number').textContent = saleToPay.billNumber;
            document.getElementById('payment-merchant-name').textContent = saleToPay.merchantName;
            document.getElementById('payment-total-amount').textContent = saleToPay.totalAmount.toFixed(2);
            document.getElementById('payment-balance-due').textContent = saleToPay.balanceDue.toFixed(2);
            document.getElementById('payment-amount-input').value = saleToPay.balanceDue.toFixed(2);

            document.getElementById('payment-modal').classList.remove('hidden');

        } catch (error) {
            console.error("Error opening payment modal: ", error);
            showFlashMessage('Error loading sale for payment. Please try again.', 'error');
        }
    }

    async function openBillModal(saleId) {
        try {
            const docRef = salesCollection.doc(saleId);
            const docSnap = await docRef.get();

            if (!docSnap.exists) {
                showFlashMessage('Sale not found for bill view.', 'error');
                return;
            }
            const saleToView = { id: docSnap.id, ...docSnap.data() };

            document.getElementById('bill-bill-number').textContent = saleToView.billNumber;
            document.getElementById('bill-date').textContent = saleToView.date;
            document.getElementById('bill-merchant-name').textContent = saleToView.merchantName;

            const productsTbody = document.getElementById('bill-products-tbody');
            productsTbody.innerHTML = '';

            saleToView.products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.bananaType}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.weightKg.toFixed(2)}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.quantity}</td>
                    <td class="border border-gray-300 px-4 py-2 text-right text-sm text-gray-800">
                        ${(product.weightKg * saleToView.overallPricePerKg).toFixed(2)}
                    </td>
                `;
                productsTbody.appendChild(row);
            });

            // Update the bill to show Gross, Wastage, and Net Billed Weights
            document.getElementById('bill-gross-weight').textContent = (saleToView.totalWeightKg || 0).toFixed(2);
            document.getElementById('bill-wastage-weight').textContent = (saleToView.wastageWeightKg || 0).toFixed(2);
            document.getElementById('bill-net-billed-weight').textContent = (saleToView.netWeightKg || 0).toFixed(2);

            document.getElementById('bill-total-quantity').textContent = saleToView.totalQuantity;
            document.getElementById('bill-overall-price-per-kg').textContent = saleToView.overallPricePerKg.toFixed(2);
            document.getElementById('bill-total-amount').textContent = saleToView.totalAmount.toFixed(2);
            document.getElementById('bill-amount-received').textContent = saleToView.amountReceived.toFixed(2);
            document.getElementById('bill-balance-due').textContent = saleToView.balanceDue.toFixed(2);

            document.getElementById('bill-view-modal').classList.remove('hidden');

        } catch (error) {
            console.error("Error opening bill modal: ", error);
            showFlashMessage('Error loading bill data. Please try again.', 'error');
        }
    }

    // Confirmation Modal Logic (for Delete)
    let currentConfirmAction = null;

    function openConfirmModal(actionType, saleId) {
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessageElement = document.getElementById('confirm-message');

        if (actionType === 'delete') {
            confirmMessageElement.textContent = "Are you sure you want to delete this sale record? This action cannot be undone.";
            currentConfirmAction = async () => {
                try {
                    await salesCollection.doc(saleId).delete();
                    showFlashMessage('Sale deleted successfully!', 'success');
                    confirmModal.classList.add('hidden');
                    renderSalesList();
                } catch (error) {
                    console.error("Error deleting sale: ", error);
                    showFlashMessage('Error deleting sale. Please try again.', 'error');
                    confirmModal.classList.add('hidden');
                }
            };
        }

        confirmModal.classList.remove('hidden');
    }


    // --- Firebase Initialization and Main Event Listeners (on DOMContentLoaded) ---
    // This block runs once the HTML document is fully loaded.
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration ---
        // IMPORTANT: Replace these placeholder values with your actual Firebase project configuration!
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDNWaOPTn1GiT8zAWFfXxiYuA-depTisCc",
  authDomain: "my-banana-sales-app.firebaseapp.com",
  projectId: "my-banana-sales-app",
  storageBucket: "my-banana-sales-app.firebasestorage.app",
  messagingSenderId: "461621717926",
  appId: "1:461621717926:web:078f5f43bb35bcce93fd67",
  measurementId: "G-PTW713Z5VN"
};

        // Log the firebaseConfig for debugging - check if it matches what you expect
        console.log("Firebase Config:", firebaseConfig);

        // Initialize Firebase and setup database references
        try {
            // Check if firebase object exists before initializing
            if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                console.error("Firebase SDK not loaded. Please check your network and script tags.");
                document.getElementById('sales-list-container').innerHTML = '<p class="text-red-600 text-center py-4">Firebase SDK did not load. Check network and script tags in HTML.</p>';
                showFlashMessage('Firebase SDK not found. Check console.', 'error');
                return; // Stop further execution if SDK isn't loaded
            }

            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(); // Assign to global db variable
            salesCollection = db.collection('sales'); // Assign to global salesCollection variable
            billCounterDocRef = db.collection('metadata').doc('billCounter'); // Initialize bill counter reference
            console.log("Firebase initialized successfully.");

            // Initial render of sales data
            renderSalesList();
            addInitialNewProductRow(); // For the 'Add New Sale' form initially

        } catch (initError) {
            console.error("Firebase Initialization Error (caught):", initError);
            document.getElementById('sales-list-container').innerHTML = '<p class="text-red-600 text-center py-4">Error initializing Firebase. Please check your console for details and ensure your `firebaseConfig` is correct.</p>';
            showFlashMessage('Application initialization failed. Check console for Firebase config errors.', 'error');
            return; // Stop execution if Firebase fails to initialize
        }

        // --- Event Listeners for Modals and Forms (set up AFTER Firebase is initialized and DOM is ready) ---

        // Add Sale Modal
        document.getElementById('add-sale-btn').addEventListener('click', () => {
            document.getElementById('new-sale-date').value = '';
            document.getElementById('new-merchant-name').value = '';
            document.getElementById('new-overall-price-per-kg').value = '';
            document.getElementById('new-wastage-weight-kg').value = '0'; // Reset wastage on new sale
            addInitialNewProductRow();
            document.getElementById('add-sale-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-add-sale-btn').addEventListener('click', () => {
            document.getElementById('add-sale-modal').classList.add('hidden');
        });
        document.getElementById('add-new-product-row-btn').addEventListener('click', addNewProductRow);
        document.getElementById('new-overall-price-per-kg').addEventListener('input', updateNewTotals);
        // Add listener for wastage input as well
        document.getElementById('new-wastage-weight-kg').addEventListener('input', updateNewTotals);

        document.getElementById('add-sale-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            try {
                const newSaleDate = document.getElementById('new-sale-date').value;
                const newMerchantName = document.getElementById('new-merchant-name').value;
                const newOverallPricePerKg = parseFloat(document.getElementById('new-overall-price-per-kg').value);
                const newWastageWeight = parseFloat(document.getElementById('new-wastage-weight-kg').value) || 0; // Get wastage weight

                const productRows = document.querySelectorAll('#new-products-container .product-row');
                const products = [];
                let totalGrossWeightKg = 0; // Renamed to gross
                let totalQuantity = 0;

                let isValid = true;
                if (productRows.length === 0) {
                    showFlashMessage('Please add at least one banana product.', 'error');
                    isValid = false;
                }

                productRows.forEach(row => {
                    const bananaType = row.querySelector('select[name="banana_type[]"]').value;
                    const weightInput = row.querySelector('input[name="weight_kg[]"]');
                    const quantityInput = row.querySelector('input[name="quantity[]"]');

                    const weight = parseFloat(weightInput.value);
                    const quantity = parseInt(quantityInput.value);

                    if (!bananaType || isNaN(weight) || weight <= 0 || isNaN(quantity) || quantity <= 0) {
                        showFlashMessage('Please fill all product fields with valid positive numbers for each entry.', 'error');
                        isValid = false;
                    }
                    products.push({ bananaType, weightKg: weight, quantity: quantity });
                    totalGrossWeightKg += weight;
                    totalQuantity += quantity;
                });

                if (!isValid) return; // Stop if product data is invalid

                // Calculate Net Billed Weight
                let netBilledWeightKg = totalGrossWeightKg - newWastageWeight;
                if (netBilledWeightKg < 0) { // Ensure net weight doesn't go negative
                    netBilledWeightKg = 0;
                    showFlashMessage('Wastage weight cannot exceed gross weight. Net billed weight adjusted to 0.', 'error');
                }

                if (isNaN(newOverallPricePerKg) || newOverallPricePerKg <= 0) {
                    showFlashMessage('Please enter a valid positive Overall Price per kg.', 'error');
                    return;
                }

                const totalAmount = netBilledWeightKg * newOverallPricePerKg; // Calculate total amount based on NET billed weight

                const nextBillNumber = await getAndIncrementBillNumber(); // Get the next sequential bill number
                if (nextBillNumber === null) {
                    // Error already handled by getAndIncrementBillNumber
                    return;
                }

                const newSale = {
                    billNumber: `BILL-${nextBillNumber}`, // Use the sequential bill number
                    date: newSaleDate,
                    merchantName: newMerchantName,
                    products: products,
                    totalWeightKg: totalGrossWeightKg, // Store gross weight
                    wastageWeightKg: newWastageWeight, // Store wastage weight
                    netWeightKg: netBilledWeightKg, // Store net billed weight
                    totalQuantity: totalQuantity,
                    overallPricePerKg: newOverallPricePerKg,
                    totalAmount: totalAmount,
                    amountReceived: 0,
                    balanceDue: totalAmount
                };

                await salesCollection.add(newSale);
                showFlashMessage('Sale added successfully!', 'success');

                document.getElementById('add-sale-modal').classList.add('hidden');
                document.getElementById('add-sale-form').reset();
                renderSalesList();

            } catch (error) {
                console.error("Error adding sale: ", error);
                showFlashMessage('Error adding sale. Please try again.', 'error');
            }
        });

        // Edit Sale Modal
        document.getElementById('add-edit-product-row-btn').addEventListener('click', addEditProductRow);
        document.getElementById('edit-overall-price-per-kg').addEventListener('input', updateEditTotals);
        // Add listener for wastage input as well
        document.getElementById('edit-wastage-weight-kg').addEventListener('input', updateEditTotals);

        document.getElementById('cancel-edit-sale-btn').addEventListener('click', () => {
            document.getElementById('edit-sale-modal').classList.add('hidden');
        });
        document.getElementById('edit-sale-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            try {
                const saleId = document.getElementById('edit-sale-id').value;
                const updatedDate = document.getElementById('edit-sale-date').value;
                const updatedMerchant = document.getElementById('edit-merchant-name').value;
                const updatedOverallPricePerKg = parseFloat(document.getElementById('edit-overall-price-per-kg').value);
                const updatedWastageWeight = parseFloat(document.getElementById('edit-wastage-weight-kg').value) || 0; // Get wastage weight

                const productRows = document.querySelectorAll('#edit-products-container .product-row');
                const updatedProducts = [];
                let updatedTotalGrossWeightKg = 0; // Renamed to gross
                let updatedTotalQuantity = 0;

                let isValid = true;
                if (productRows.length === 0) {
                    showFlashMessage('Please add at least one banana product for editing.', 'error');
                    isValid = false;
                }

                productRows.forEach(row => {
                    const bananaType = row.querySelector('select[name="banana_type[]"]').value;
                    const weightInput = row.querySelector('input[name="weight_kg[]"]');
                    const quantityInput = row.querySelector('input[name="quantity[]"]');

                    const weight = parseFloat(weightInput.value);
                    const quantity = parseInt(quantityInput.value);

                    if (!bananaType || isNaN(weight) || weight <= 0 || isNaN(quantity) || quantity <= 0) {
                        showFlashMessage('Please fill all product fields with valid positive numbers for each entry.', 'error');
                        isValid = false;
                    }
                    updatedProducts.push({ bananaType, weightKg: weight, quantity: quantity });
                    updatedTotalGrossWeightKg += weight;
                    updatedTotalQuantity += quantity;
                });

                if (!isValid) return; // Stop if product data is invalid

                // Calculate Net Billed Weight
                let updatedNetBilledWeightKg = updatedTotalGrossWeightKg - updatedWastageWeight;
                if (updatedNetBilledWeightKg < 0) {
                    updatedNetBilledWeightKg = 0;
                    showFlashMessage('Wastage weight cannot exceed gross weight. Net billed weight adjusted to 0.', 'error');
                }

                if (isNaN(updatedOverallPricePerKg) || updatedOverallPricePerKg <= 0) {
                    showFlashMessage('Please enter a valid positive Overall Price per kg.', 'error');
                    return;
                }

                const updatedTotalAmount = updatedNetBilledWeightKg * updatedOverallPricePerKg; // Use netBilledWeight

                const currentSaleDoc = await salesCollection.doc(saleId).get();
                if (!currentSaleDoc.exists) {
                    showFlashMessage('Error: Sale not found for update.', 'error');
                    return;
                }
                const currentSaleData = currentSaleDoc.data();
                const currentAmountReceived = currentSaleData.amountReceived || 0;

                let updatedBalanceDue = updatedTotalAmount - currentAmountReceived;
                if (updatedBalanceDue < 0) {
                    updatedBalanceDue = 0;
                }

                const updateData = {
                    date: updatedDate,
                    merchantName: updatedMerchant,
                    products: updatedProducts,
                    totalWeightKg: updatedTotalGrossWeightKg, // Store updated gross weight
                    wastageWeightKg: updatedWastageWeight, // Store updated wastage weight
                    netWeightKg: updatedNetBilledWeightKg, // Store updated net billed weight
                    totalQuantity: updatedTotalQuantity,
                    overallPricePerKg: updatedOverallPricePerKg,
                    totalAmount: updatedTotalAmount,
                    balanceDue: updatedBalanceDue
                };

                await salesCollection.doc(saleId).update(updateData);
                showFlashMessage('Sale updated successfully!', 'success');

                document.getElementById('edit-sale-modal').classList.add('hidden');
                renderSalesList();

            } catch (error) {
                console.error("Error updating sale: ", error);
                showFlashMessage('Error updating sale. Please try again.', 'error');
            }
        });

        // Payment Modal
        document.getElementById('cancel-payment-btn').addEventListener('click', () => {
            document.getElementById('payment-modal').classList.add('hidden');
        });
        document.getElementById('payment-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            try {
                const saleId = document.getElementById('payment-sale-id').value;
                const paymentAmount = parseFloat(document.getElementById('payment-amount-input').value);

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showFlashMessage('Please enter a valid positive payment amount.', 'error');
                    return;
                }

                const docRef = salesCollection.doc(saleId);
                const docSnap = await docRef.get();
                if (!docSnap.exists) {
                    showFlashMessage('Error: Sale not found for payment update.', 'error');
                    return;
                }
                const currentSaleData = docSnap.data();

                let newAmountReceived = (currentSaleData.amountReceived || 0) + paymentAmount;
                let newBalanceDue = currentSaleData.totalAmount - newAmountReceived;
                if (newBalanceDue < 0) {
                    newBalanceDue = 0;
                }

                await docRef.update({
                    amountReceived: newAmountReceived,
                    balanceDue: newBalanceDue
                });

                showFlashMessage('Payment recorded successfully!', 'success');
                document.getElementById('payment-modal').classList.add('hidden');
                renderSalesList();

            } catch (error) {
                console.error("Error updating payment: ", error);
                showFlashMessage('Error updating payment. Please try again.', 'error');
            }
        });

        // Bill View Modal
        document.getElementById('close-bill-btn').addEventListener('click', () => {
            document.getElementById('bill-view-modal').classList.add('hidden');
        });

        // Modified print bill function
        document.getElementById('print-bill-btn').addEventListener('click', () => {
            const billContent = document.getElementById('bill-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Bill</title>
                    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #374151;
                        }
                        /* Ensure the bill content is visible and styled for printing */
                        #bill-content {
                            width: 100%;
                            box-sizing: border-box;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            border: 1px solid #e5e7eb; /* gray-300 */
                            padding: 8px 16px;
                            text-align: left;
                        }
                        th {
                            background-color: #f3f4f6; /* gray-100 */
                            font-weight: 600;
                            color: #4b5563; /* gray-700 */
                        }
                        .text-right { text-align: right; }
                        .font-bold { font-weight: 700; }
                        .text-green-700 { color: #047857; }
                        .text-blue-700 { color: #1d4ed8; }
                        .text-red-600 { color: #dc2626; }
                    </style>
                </head>
                <body>
                    ${billContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            // No need to reload the main window, as its DOM was not affected
        });


        // Confirmation Modal (for Delete)
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            currentConfirmAction = null;
        });
        document.getElementById('execute-confirm-btn').addEventListener('click', () => {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
        });

    }); // End of DOMContentLoaded
</script>
