import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from 'firebase/firestore';

// Global variables provided by the Canvas environment
// Access these safely within the React component's scope
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Firebase Configuration - Using provided values as fallback
let firebaseConfig = {};
if (typeof window.__firebase_config === 'string' && window.__firebase_config.trim().startsWith('{')) {
    try {
        firebaseConfig = JSON.parse(window.__firebase_config);
        console.log("Firebase Config (parsed from window.__firebase_config):", firebaseConfig);
    } catch (e) {
        console.error("Error parsing window.__firebase_config. It might not be valid JSON:", e);
        // Fallback to hardcoded values if parsing fails
        firebaseConfig = {
            apiKey: "AIzaSyDNWaOPTn1GiT8zAWFfXxiYuA-depTisCc",
            authDomain: "my-banana-sales-app.firebaseapp.com",
            projectId: "my-banana-sales-app",
            storageBucket: "my-banana-sales-app.firebasestorage.app",
            messagingSenderId: "461621717926",
            appId: "1:461621717926:web:078f5f43bb35bcce93fd67",
            measurementId: "G-PTW713Z5VN"
        };
        console.log("Firebase Config (hardcoded fallback due to parse error):", firebaseConfig);
    }
} else {
    console.warn("No valid window.__firebase_config string provided by environment or it's empty. Using hardcoded fallback.");
    // Fallback for local testing or if window.__firebase_config is truly not defined or empty
    firebaseConfig = {
        apiKey: "AIzaSyDNWaOPTn1GiT8zAWFfXxiYuA-depTisCc",
        authDomain: "my-banana-sales-app.firebaseapp.com",
        projectId: "my-banana-sales-app",
        storageBucket: "my-banana-sales-app.firebasestorage.app",
        messagingSenderId: "461621717926",
        appId: "1:461621717926:web:078f5f43bb35bcce93fd67",
        measurementId: "G-PTW713Z5VN"
    };
    console.log("Firebase Config (hardcoded fallback):", firebaseConfig);
}

const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [sales, setSales] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Form states for adding a new sale
    const [newSaleBillNumber, setNewSaleBillNumber] = useState(''); // NEW: Manual bill number input
    const [newSaleDate, setNewSaleDate] = useState('');
    const [newSaleMerchant, setNewSaleMerchant] = useState('');
    const [newSaleProducts, setNewSaleProducts] = useState([{ bananaType: '', weightKg: '', quantity: '' }]);
    const [newSaleOverallPricePerKg, setNewSaleOverallPricePerKg] = useState('');
    const [newSaleWastageWeight, setNewSaleWastageWeight] = useState(0); // New state for wastage

    // State for payment modal
    const [showPaymentModal, setShowPaymentModal] = useState(false);
    const [currentSaleToPay, setCurrentSaleToPay] = useState(null);
    const [paymentAmount, setPaymentAmount] = useState('');

    // State for bill modal
    const [showBillModal, setShowBillModal] = useState(false);
    const [currentBillSale, setCurrentBillSale] = useState(null);

    // State for confirmation modal (for delete)
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState(null);
    const [confirmMessage, setConfirmMessage] = useState(''); // Initialize as empty string

    // States for editing an existing sale
    const [showEditModal, setShowEditModal] = useState(false);
    const [currentSaleToEdit, setCurrentSaleToEdit] = useState(null);
    const [editSaleDate, setEditSaleDate] = useState('');
    const [editSaleMerchant, setEditSaleMerchant] = useState('');
    const [editSaleProducts, setEditSaleProducts] = useState([{ bananaType: '', weightKg: '', quantity: '' }]);
    const [editSaleOverallPricePerKg, setEditSaleOverallPricePerKg] = useState('');
    const [editSaleWastageWeight, setEditSaleWastageWeight] = useState(0); // New state for wastage in edit

    // Predefined banana types for dropdown
    const bananaTypes = ["Red Banana", "Robusta", "Matti", "Athan"];

    // Initialize Firebase and set up authentication listener
    useEffect(() => {
        try {
            // Check if firebaseConfig is valid before proceeding
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                console.error("Firebase configuration is missing or invalid (e.g., no API Key). Cannot initialize Firebase.");
                setError("Firebase configuration missing or invalid. Check console for details.");
                setLoading(false);
                return;
            }

            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestoreDb);
            setAuth(firebaseAuth);

            // Listen for authentication state changes
            const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsAuthenticated(true);
                    console.log("User authenticated:", user.uid);
                } else {
                    // If no user, try to sign in with custom token or anonymously
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(firebaseAuth);
                            console.log("Signed in anonymously.");
                        }
                    } catch (authError) {
                        console.error("Firebase Auth Error:", authError);
                        setError(`Authentication failed: ${authError.message}`);
                        setLoading(false);
                    }
                }
                setLoading(false); // Authentication process completed
            });

            return () => unsubscribeAuth(); // Cleanup auth listener on unmount
        } catch (err) {
            console.error("Failed to initialize Firebase:", err);
            setError(`Failed to initialize application: ${err.message}`);
            setLoading(false);
        }
    }, []);

    // Fetch sales data when authenticated and db is ready
    useEffect(() => {
        if (db && isAuthenticated && userId) {
            setLoading(true);
            setError(null);
            // IMPORTANT: Collection path is now updated to match security rules
            const salesCollectionRef = collection(db, `artifacts/${appId}/public/data/sales`);
            // Order by timestamp to show most recent sales first
            const q = query(salesCollectionRef, orderBy('timestamp', 'desc'));

            const unsubscribeSales = onSnapshot(q, (snapshot) => {
                const salesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setSales(salesData);
                setLoading(false);
            }, (err) => {
                console.error("Error fetching sales:", err);
                setError(`Failed to load sales data: ${err.message}`);
                setLoading(false);
            });

            return () => unsubscribeSales(); // Cleanup sales listener on unmount
        }
    }, [db, isAuthenticated, userId]);

    // --- NEW SALE FORM LOGIC ---

    // Handle changes to product fields (bananaType, weightKg, or quantity) for NEW SALE
    const handleNewProductChange = (index, field, value) => {
        const updatedProducts = newSaleProducts.map((product, i) =>
            i === index ? { ...product, [field]: value } : product
        );
        setNewSaleProducts(updatedProducts);
    };

    // Add a new empty product row for NEW SALE
    const addNewProductRow = () => {
        setNewSaleProducts([...newSaleProducts, { bananaType: '', weightKg: '', quantity: '' }]);
    };

    // Remove a product row for NEW SALE
    const removeNewProductRow = (index) => {
        if (newSaleProducts.length > 1) {
            const updatedProducts = newSaleProducts.filter((_, i) => i !== index);
            setNewSaleProducts(updatedProducts);
        } else {
            setError("A sale must have at least one product.");
        }
    };

    // Calculate gross weight for the new sale form
    const calculateNewGrossWeight = useCallback(() => {
        return newSaleProducts.reduce((sum, product) => {
            const weight = parseFloat(product.weightKg);
            return sum + (isNaN(weight) ? 0 : weight);
        }, 0);
    }, [newSaleProducts]);

    // Calculate net billed weight for the new sale form
    const calculateNewNetBilledWeight = useCallback(() => {
        const grossWeight = calculateNewGrossWeight();
        return Math.max(0, grossWeight - (parseFloat(newSaleWastageWeight) || 0));
    }, [calculateNewGrossWeight, newSaleWastageWeight]);

    // Calculate total quantity for the new sale form
    const calculateNewTotalQuantity = useCallback(() => {
        return newSaleProducts.reduce((sum, product) => {
            const quantity = parseInt(product.quantity);
            return sum + (isNaN(quantity) ? 0 : quantity);
        }, 0);
    }, [newSaleProducts]);

    // Calculate total amount for NEW SALE form (Net Billed Weight * Overall Price per Kg)
    const calculateNewTotalAmountDue = useCallback(() => {
        const netBilledWeight = calculateNewNetBilledWeight();
        const overallPrice = parseFloat(newSaleOverallPricePerKg);
        if (!isNaN(netBilledWeight) && !isNaN(overallPrice)) {
            return (netBilledWeight * overallPrice);
        }
        return 0;
    }, [newSaleOverallPricePerKg, calculateNewNetBilledWeight]);

    // Handle adding a new sale
    const handleAddSale = async (e) => {
        e.preventDefault();
        setError(null); // Clear previous errors

        if (!db || !userId) {
            setError("Database not ready or user not authenticated.");
            return;
        }

        const grossWeight = calculateNewGrossWeight();
        const netBilledWeight = calculateNewNetBilledWeight();
        const totalQuantity = calculateNewTotalQuantity();
        const overallPrice = parseFloat(newSaleOverallPricePerKg);
        const totalAmount = calculateNewTotalAmountDue();

        // Basic validation for main sale fields and NEW bill number
        if (!newSaleBillNumber.trim() || !newSaleDate || !newSaleMerchant.trim() || isNaN(overallPrice) || overallPrice <= 0) {
            setError("Please fill in Bill Number, Date, Merchant Name, and a valid Overall Price per kg.");
            return;
        }

        // Validate products: ensure at least one product and all product fields are valid
        const hasInvalidProducts = newSaleProducts.some(product =>
            !product.bananaType.trim() || isNaN(parseFloat(product.weightKg)) || parseFloat(product.weightKg) <= 0 ||
            isNaN(parseInt(product.quantity)) || parseInt(product.quantity) <= 0
        );

        if (newSaleProducts.length === 0 || hasInvalidProducts) {
            setError("Please add at least one banana product with a valid type, positive weight, and positive quantity.");
            return;
        }

        if (netBilledWeight < 0) {
            setError("Wastage weight cannot exceed gross weight.");
            return;
        }

        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/sales`), { // Updated collection path
                billNumber: newSaleBillNumber.trim(), // Use manually entered bill number
                date: newSaleDate,
                merchantName: newSaleMerchant.trim(),
                products: newSaleProducts.map(p => ({
                    bananaType: p.bananaType.trim(),
                    weightKg: parseFloat(p.weightKg),
                    quantity: parseInt(p.quantity)
                })),
                totalWeightKg: grossWeight, // Store gross weight
                wastageWeightKg: parseFloat(newSaleWastageWeight) || 0, // Store wastage
                netWeightKg: netBilledWeight, // Store net billed weight
                totalQuantity: totalQuantity,
                overallPricePerKg: overallPrice,
                totalAmount: totalAmount,
                amountReceived: 0, // Initially no amount received
                balanceDue: totalAmount, // Initially balance due is total amount
                userId: userId,
                timestamp: serverTimestamp() // Add a timestamp for ordering
            });
            // Clear form fields after successful addition
            setNewSaleBillNumber(''); // Clear bill number
            setNewSaleDate('');
            setNewSaleMerchant('');
            setNewSaleProducts([{ bananaType: '', weightKg: '', quantity: '' }]); // Reset to one empty product row
            setNewSaleOverallPricePerKg('');
            setNewSaleWastageWeight(0);
            setError(null);
        } catch (err) {
            console.error("Error adding sale:", err);
            setError(`Failed to add sale: ${err.message}`);
        }
    };

    // --- EDIT SALE FORM LOGIC ---

    // Handle changes to product fields for EDIT SALE
    const handleEditProductChange = (index, field, value) => {
        const updatedProducts = editSaleProducts.map((product, i) =>
            i === index ? { ...product, [field]: value } : product
        );
        setEditSaleProducts(updatedProducts);
    };

    // Add a new empty product row for EDIT SALE
    const addEditProductRow = () => {
        setEditSaleProducts([...editSaleProducts, { bananaType: '', weightKg: '', quantity: '' }]);
    };

    // Remove a product row for EDIT SALE
    const removeEditProductRow = (index) => {
        if (editSaleProducts.length > 1) {
            const updatedProducts = editSaleProducts.filter((_, i) => i !== index);
            setEditSaleProducts(updatedProducts);
        } else {
            setError("A sale must have at least one product.");
        }
    };

    // Calculate gross weight for the edit sale form
    const calculateEditGrossWeight = useCallback(() => {
        return editSaleProducts.reduce((sum, product) => {
            const weight = parseFloat(product.weightKg);
            return sum + (isNaN(weight) ? 0 : weight);
        }, 0);
    }, [editSaleProducts]);

    // Calculate net billed weight for the edit sale form
    const calculateEditNetBilledWeight = useCallback(() => {
        const grossWeight = calculateEditGrossWeight();
        return Math.max(0, grossWeight - (parseFloat(editSaleWastageWeight) || 0));
    }, [calculateEditGrossWeight, editSaleWastageWeight]);

    // Calculate total quantity for the edit sale form
    const calculateEditTotalQuantity = useCallback(() => {
        return editSaleProducts.reduce((sum, product) => {
            const quantity = parseInt(product.quantity);
            return sum + (isNaN(quantity) ? 0 : quantity);
        }, 0);
    }, [editSaleProducts]);

    // Calculate total amount for EDIT SALE form (Net Billed Weight * Overall Price per Kg)
    const calculateEditTotalAmountDue = useCallback(() => {
        const netBilledWeight = calculateEditNetBilledWeight();
        const overallPrice = parseFloat(editSaleOverallPricePerKg);
        if (!isNaN(netBilledWeight) && !isNaN(overallPrice)) {
            return (netBilledWeight * overallPrice);
        }
        return 0;
    }, [editSaleOverallPricePerKg, calculateEditNetBilledWeight]);

    // Open Edit modal
    const openEditModal = (sale) => {
        setCurrentSaleToEdit(sale);
        setEditSaleDate(sale.date);
        setEditSaleMerchant(sale.merchantName);
        // Ensure products are copied, not just referenced
        setEditSaleProducts(sale.products ? sale.products.map(p => ({ ...p })) : [{ bananaType: '', weightKg: '', quantity: '' }]);
        setEditSaleOverallPricePerKg(sale.overallPricePerKg.toFixed(2));
        setEditSaleWastageWeight(sale.wastageWeightKg || 0); // Set wastage for edit
        setShowEditModal(true);
    };

    // Handle updating an existing sale
    const handleUpdateSale = async (e) => {
        e.preventDefault();
        setError(null); // Clear previous errors

        if (!db || !currentSaleToEdit || !userId) {
            setError("Database not ready or sale not selected for editing.");
            return;
        }

        const updatedGrossWeight = calculateEditGrossWeight();
        const updatedNetBilledWeight = calculateEditNetBilledWeight();
        const updatedTotalQuantity = calculateEditTotalQuantity();
        const updatedOverallPrice = parseFloat(editSaleOverallPricePerKg);
        const updatedTotalAmount = calculateEditTotalAmountDue();

        if (!editSaleDate || !editSaleMerchant.trim() || isNaN(updatedOverallPrice) || updatedOverallPrice <= 0) {
            setError("Please fill in Date, Merchant Name, and a valid Overall Price per kg for editing.");
            return;
        }

        const hasInvalidEditProducts = editSaleProducts.some(product =>
            !product.bananaType.trim() || isNaN(parseFloat(product.weightKg)) || parseFloat(product.weightKg) <= 0 ||
            isNaN(parseInt(product.quantity)) || parseInt(product.quantity) <= 0
        );

        if (editSaleProducts.length === 0 || hasInvalidEditProducts) {
            setError("Please add at least one banana product with a valid type, positive weight, and positive quantity for editing.");
            return;
        }

        if (updatedNetBilledWeight < 0) {
            setError("Wastage weight cannot exceed gross weight.");
            return;
        }

        // Recalculate balanceDue based on new totalAmount and existing amountReceived
        const newBalanceDue = updatedTotalAmount - currentSaleToEdit.amountReceived;

        try {
            const saleRef = doc(db, `artifacts/${appId}/public/data/sales`, currentSaleToEdit.id); // Updated collection path
            await updateDoc(saleRef, {
                date: editSaleDate,
                merchantName: editSaleMerchant.trim(),
                products: editSaleProducts.map(p => ({
                    bananaType: p.bananaType.trim(),
                    weightKg: parseFloat(p.weightKg),
                    quantity: parseInt(p.quantity)
                })),
                totalWeightKg: updatedGrossWeight, // Store updated gross weight
                wastageWeightKg: parseFloat(editSaleWastageWeight) || 0, // Store updated wastage
                netWeightKg: updatedNetBilledWeight, // Store updated net billed weight
                totalQuantity: updatedTotalQuantity,
                overallPricePerKg: updatedOverallPrice,
                totalAmount: updatedTotalAmount,
                balanceDue: newBalanceDue < 0 ? 0 : newBalanceDue // Ensure balance doesn't go negative
            });
            setShowEditModal(false);
            setCurrentSaleToEdit(null);
            setError(null);
        } catch (err) {
            console.error("Error updating sale:", err);
            setError(`Failed to update sale: ${err.message}`);
        }
    };

    // --- PAYMENT MODAL LOGIC ---

    // Open payment modal
    const openPaymentModal = (sale) => {
        setCurrentSaleToPay(sale);
        setPaymentAmount(sale.balanceDue.toFixed(2)); // Pre-fill with outstanding
        setShowPaymentModal(true);
    };

    // Handle recording payment
    const handleRecordPayment = async () => {
        setError(null); // Clear previous errors
        if (!db || !currentSaleToPay || !userId) {
            setError("Database not ready or sale not selected.");
            return;
        }

        const amount = parseFloat(paymentAmount);
        if (isNaN(amount) || amount <= 0) {
            setError("Please enter a valid positive payment amount.");
            return;
        }

        const newAmountReceived = currentSaleToPay.amountReceived + amount;
        const newBalanceDue = currentSaleToPay.totalAmount - newAmountReceived;

        try {
            const saleRef = doc(db, `artifacts/${appId}/public/data/sales`, currentSaleToPay.id); // Updated collection path
            await updateDoc(saleRef, {
                amountReceived: newAmountReceived,
                balanceDue: newBalanceDue < 0 ? 0 : newBalanceDue // Ensure balance doesn't go negative
            });
            setShowPaymentModal(false);
            setCurrentSaleToPay(null);
            setPaymentAmount('');
            setError(null);
        } catch (err) {
            console.error("Error updating payment:", err);
            setError(`Failed to record payment: ${err.message}`);
        }
    };

    // --- BILL MODAL LOGIC ---

    // Open bill modal
    const openBillModal = (sale) => {
        setCurrentBillSale(sale);
        setShowBillModal(true);
    };

    // Handle printing the bill
    const handlePrintBill = () => {
        // Create a temporary iframe or new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Print Bill</title>
                <link href="https://cdn.tailwindcss.com" rel="stylesheet">
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
                <style>
                    body {
                        font-family: 'Inter', sans-serif;
                        margin: 0;
                        padding: 20px;
                        color: #374151;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    th, td {
                        border: 1px solid #e5e7eb; /* gray-300 */
                        padding: 8px 16px;
                        text-align: left;
                    }
                    th {
                        background-color: #f3f4f6; /* gray-100 */
                        font-weight: 600;
                        color: #4b5563; /* gray-700 */
                    }
                    .text-right { text-align: right; }
                    .font-bold { font-weight: 700; }
                    .text-green-700 { color: #047857; }
                    .text-blue-700 { color: #1d4ed8; }
                    .text-red-600 { color: #dc2626; }
                </style>
            </head>
            <body>
                <div className="p-4 border border-gray-300 rounded-md">
                    <h2 className="text-2xl font-bold text-center text-green-800 mb-4">Banana Sales Bill</h2>
                    <div className="mb-4 text-sm">
                        <p><strong>Bill Number:</strong> ${currentBillSale.billNumber}</p>
                        <p><strong>Date:</strong> ${currentBillSale.date}</p>
                        <p><strong>Seller:</strong> ALPHONSE N</p>
                        <p><strong>Address:</strong> Nagercoil Pampanvilai Anandanadarkudi Road</p>
                        <p><strong>Contact:</strong> +91 9443391054</p>
                    </div>
                    <div className="mb-6">
                        <p className="text-lg font-semibold mb-2">Bill To:</p>
                        <p className="text-xl font-bold text-gray-800">${currentBillSale.merchantName}</p>
                    </div>

                    <table className="min-w-full mb-6 border-collapse border border-gray-300">
                        <thead>
                            <tr className="bg-gray-100">
                                <th className="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Description (Banana Type)</th>
                                <th className="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Weight (kg)</th>
                                <th className="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Quantity</th>
                                <th className="border border-gray-300 px-4 py-2 text-right text-sm font-medium text-gray-700">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentBillSale.products && currentBillSale.products.map((product, index) => `
                                <tr key=${index}>
                                    <td className="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.bananaType}</td>
                                    <td className="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.weightKg.toFixed(2)}</td>
                                    <td className="border border-gray-300 px-4 py-2 text-sm text-gray-800">${product.quantity}</td>
                                    <td className="border border-gray-300 px-4 py-2 text-right text-sm text-gray-800">
                                        ${(product.weightKg * currentBillSale.overallPricePerKg).toFixed(2)}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Gross Weight:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold">${(currentBillSale.totalWeightKg || 0).toFixed(2)} kg</td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Wastage (Stem) Weight:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold text-red-600">
                                    - ${(currentBillSale.wastageWeightKg || 0).toFixed(2)} kg
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Net Billed Weight:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold text-blue-700">
                                    ${(currentBillSale.netWeightKg || 0).toFixed(2)} kg
                                </td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Total Quantity:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold">${currentBillSale.totalQuantity || '0'}</td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Overall Price/kg:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold">₹${currentBillSale.overallPricePerKg ? currentBillSale.overallPricePerKg.toFixed(2) : '0.00'}</td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Total Amount:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold text-green-700">₹${currentBillSale.totalAmount.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Amount Received:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold text-blue-700">₹${currentBillSale.amountReceived.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Balance Due:</td>
                                <td className="border border-gray-300 px-4 py-2 text-right font-bold text-red-700">₹${currentBillSale.balanceDue.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <div className="text-sm mt-6 text-center">
                        <p>Thank you for your business!</p>
                        <p className="mt-4">_________________________</p>
                        <p>Signature</p>
                    </div>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close(); // Close the print window after printing
    };

    // --- CONFIRMATION MODAL LOGIC ---

    // Open confirmation modal for deletion
    const openConfirmModal = (saleId) => {
        setConfirmMessage("Are you sure you want to delete this sale record? This action cannot be undone.");
        setConfirmAction(() => async () => {
            setError(null); // Clear previous errors
            if (!db || !userId) {
                setError("Database not ready or user not authenticated.");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/sales`, saleId)); // Updated collection path
                setError(null);
            } catch (err) {
                console.error("Error deleting sale:", err);
                setError(`Failed to delete sale: ${err.message}`);
            } finally {
                setShowConfirmModal(false);
            }
        });
        setShowConfirmModal(true);
    };

    // Calculate overall summary
    const totalSalesAmount = sales.reduce((sum, sale) => sum + sale.totalAmount, 0);
    const totalAmountReceived = sales.reduce((sum, sale) => sum + sale.amountReceived, 0);
    const totalOutstanding = sales.reduce((sum, sale) => sum + sale.balanceDue, 0);

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-xl font-semibold text-gray-700">Loading application...</div>
            </div>
        );
    }

    if (error && !isAuthenticated) { // Show error if not authenticated
        return (
            <div className="flex items-center justify-center min-h-screen bg-red-100 text-red-800 p-4 rounded-lg shadow-md">
                <p>Error: {error}</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-100 font-sans text-gray-800 p-4 sm:p-6 lg:p-8">
            <div className="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8">
                <h1 className="text-3xl sm:text-4xl font-bold text-center text-green-700 mb-6">ASPG Banana Sales Software</h1>

                {userId && (
                    <p className="text-sm text-gray-600 text-center mb-4">
                        Your User ID: <span className="font-mono bg-gray-200 px-2 py-1 rounded">{userId}</span>
                    </p>
                )}

                {error && (
                    <div className="bg-red-100 text-red-800 p-3 rounded-lg mb-4 text-center">
                        {error}
                    </div>
                )}

                {/* Sales Summary */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div className="bg-green-50 p-4 rounded-lg shadow-sm text-center">
                        <h2 className="text-lg font-semibold text-green-800">Total Sales</h2>
                        <p className="text-2xl font-bold text-green-600">₹{totalSalesAmount.toFixed(2)}</p>
                    </div>
                    <div className="bg-blue-50 p-4 rounded-lg shadow-sm text-center">
                        <h2 className="text-lg font-semibold text-blue-800">Amount Received</h2>
                        <p className="text-2xl font-bold text-blue-600">₹{totalAmountReceived.toFixed(2)}</p>
                    </div>
                    <div className="bg-yellow-50 p-4 rounded-lg shadow-sm text-center">
                        <h2 className="text-lg font-semibold text-yellow-800">Outstanding Balance</h2>
                        <p className="text-2xl font-bold text-yellow-600">₹{totalOutstanding.toFixed(2)}</p>
                    </div>
                </div>

                {/* Add New Sale Form */}
                <div className="mb-8 p-6 bg-green-50 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-green-700 mb-4">Add New Sale</h2>
                    <form onSubmit={handleAddSale} className="grid grid-cols-1 gap-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4"> {/* Adjusted grid for bill number */}
                            <div>
                                <label htmlFor="newSaleBillNumber" className="block text-sm font-medium text-gray-700">Bill Number</label>
                                <input
                                    type="text"
                                    id="newSaleBillNumber"
                                    value={newSaleBillNumber}
                                    onChange={(e) => setNewSaleBillNumber(e.target.value)}
                                    placeholder="e.g., INV-001"
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newSaleDate" className="block text-sm font-medium text-gray-700">Date</label>
                                <input
                                    type="date"
                                    id="newSaleDate"
                                    value={newSaleDate}
                                    onChange={(e) => setNewSaleDate(e.target.value)}
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newMerchantName" className="block text-sm font-medium text-gray-700">Merchant Name</label>
                                <input
                                    type="text"
                                    id="newMerchantName"
                                    value={newSaleMerchant}
                                    onChange={(e) => setNewSaleMerchant(e.target.value)}
                                    placeholder="e.g., Green Grocers"
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                    required
                                />
                            </div>
                        </div>

                        <div className="mt-4 border-t border-gray-200 pt-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-3">Banana Products</h3>
                            {newSaleProducts.map((product, index) => (
                                <div key={index} className="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-3 p-3 bg-white rounded-md shadow-sm items-end">
                                    <div>
                                        <label htmlFor={`newBananaType-${index}`} className="block text-sm font-medium text-gray-700">Banana Type</label>
                                        <select
                                            id={`newBananaType-${index}`}
                                            value={product.bananaType}
                                            onChange={(e) => handleNewProductChange(index, 'bananaType', e.target.value)}
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                            required
                                        >
                                            <option value="">Select Type</option>
                                            {bananaTypes.map((type) => (
                                                <option key={type} value={type}>{type}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label htmlFor={`newWeightKg-${index}`} className="block text-sm font-medium text-gray-700">Weight (kg)</label>
                                        <input
                                            type="number"
                                            id={`newWeightKg-${index}`}
                                            value={product.weightKg}
                                            onChange={(e) => handleNewProductChange(index, 'weightKg', e.target.value)}
                                            placeholder="e.g., 100"
                                            step="0.01"
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor={`newQuantity-${index}`} className="block text-sm font-medium text-gray-700">Quantity</label>
                                        <input
                                            type="number"
                                            id={`newQuantity-${index}`}
                                            value={product.quantity}
                                            onChange={(e) => handleNewProductChange(index, 'quantity', e.target.value)}
                                            placeholder="e.g., 50"
                                            step="1"
                                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                            required
                                        />
                                    </div>
                                    <div className="flex justify-end sm:justify-start">
                                        {newSaleProducts.length > 1 && (
                                            <button
                                                type="button"
                                                onClick={() => removeNewProductRow(index)}
                                                className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm"
                                            >
                                                Remove
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={addNewProductRow}
                                className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm mt-2"
                            >
                                Add Another Product
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Gross Weight (kg)</label>
                                <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                    {calculateNewGrossWeight().toFixed(2)} kg
                                </p>
                            </div>
                            <div>
                                <label htmlFor="newSaleWastageWeight" className="block text-sm font-medium text-gray-700">Wastage (Stem) (kg)</label>
                                <input
                                    type="number"
                                    id="newSaleWastageWeight"
                                    value={newSaleWastageWeight}
                                    onChange={(e) => setNewSaleWastageWeight(e.target.value)}
                                    placeholder="e.g., 5"
                                    step="0.01"
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Net Billed Weight (kg)</label>
                                <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-blue-700">
                                    {calculateNewNetBilledWeight().toFixed(2)} kg
                                </p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Total Quantity</label>
                                <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                    {calculateNewTotalQuantity()}
                                </p>
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="newSaleOverallPricePerKg" className="block text-sm font-medium text-gray-700">Overall Price per kg (₹)</label>
                                <input
                                    type="number"
                                    id="newSaleOverallPricePerKg"
                                    value={newSaleOverallPricePerKg}
                                    onChange={(e) => setNewSaleOverallPricePerKg(e.target.value)}
                                    placeholder="e.g., 25"
                                    step="0.01"
                                    className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                    required
                                />
                            </div>
                        </div>

                        <div className="col-span-full">
                            <label className="block text-sm font-medium text-gray-700">Total Amount Due (₹)</label>
                            <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-green-700">
                                ₹{calculateNewTotalAmountDue().toFixed(2)}
                            </p>
                        </div>

                        <div className="col-span-full flex justify-end mt-6">
                            <button
                                type="submit"
                                className="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                            >
                                Add Sale
                            </button>
                        </div>
                    </form>
                </div>

                {/* Sales List */}
                <div className="p-6 bg-white rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-green-700 mb-4">All Sales Records</h2>
                    {sales.length === 0 ? (
                        <p className="text-gray-600 text-center py-4">No sales recorded yet. Add a new sale above!</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                <thead className="bg-green-100">
                                    <tr>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Bill No.</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Date</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Merchant</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Gross Weight (kg)</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Net Weight (kg)</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total Quantity</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Overall Price/kg (₹)</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total (₹)</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Received (₹)</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Balance (₹)</th>
                                        <th className="px-4 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {sales.map((sale) => (
                                        <tr key={sale.id} className="hover:bg-gray-50">
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-medium text-gray-900">{sale.billNumber}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">{sale.date}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">{sale.merchantName}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">{sale.totalWeightKg ? sale.totalWeightKg.toFixed(2) : '0.00'}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">{sale.netWeightKg ? sale.netWeightKg.toFixed(2) : '0.00'}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">{sale.totalQuantity || '0'}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-500">{sale.overallPricePerKg ? sale.overallPricePerKg.toFixed(2) : '0.00'}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">₹{sale.totalAmount.toFixed(2)}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm text-blue-600">₹{sale.amountReceived.toFixed(2)}</td>
                                            <td className={`px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-sm font-bold ${sale.balanceDue > 0 ? 'text-red-600' : 'text-green-600'}`}>₹{sale.balanceDue.toFixed(2)}</td>
                                            <td className="px-4 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                                    <button
                                                        onClick={() => openEditModal(sale)}
                                                        className="px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 text-xs sm:text-sm"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button
                                                        onClick={() => openPaymentModal(sale)}
                                                        className="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-xs sm:text-sm"
                                                    >
                                                        Record Payment
                                                    </button>
                                                    <button
                                                        onClick={() => openBillModal(sale)}
                                                        className="px-3 py-1 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-xs sm:text-sm"
                                                    >
                                                        View Bill
                                                    </button>
                                                    <button
                                                        onClick={() => openConfirmModal(sale.id)}
                                                        className="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs sm:text-sm"
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>

            {/* Payment Modal */}
            {showPaymentModal && currentSaleToPay && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                        <h2 className="text-xl font-semibold text-green-700 mb-4">Record Payment for {currentSaleToPay.merchantName}</h2>
                        <p className="mb-2">Bill Number: {currentSaleToPay.billNumber}</p>
                        <p className="mb-2">Total Amount: ₹{currentSaleToPay.totalAmount.toFixed(2)}</p>
                        <p className="mb-4">Current Balance Due: ₹{currentSaleToPay.balanceDue.toFixed(2)}</p>
                        <label htmlFor="paymentAmount" className="block text-sm font-medium text-gray-700">Amount to Receive (₹)</label>
                        <input
                            type="number"
                            id="paymentAmount"
                            value={paymentAmount}
                            onChange={(e) => setPaymentAmount(e.target.value)}
                            step="0.01"
                            className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                            required
                        />
                        <div className="mt-6 flex justify-end space-x-3">
                            <button
                                onClick={() => setShowPaymentModal(false)}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleRecordPayment}
                                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                            >
                                Update Payment
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Bill View Modal */}
            {showBillModal && currentBillSale && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
                        {/* The bill content is now generated dynamically within handlePrintBill for actual printing */}
                        {/* For display, we render it here */}
                        <div className="p-4 border border-gray-300 rounded-md">
                            <h2 className="text-2xl font-bold text-center text-green-800 mb-4">Banana Sales Bill</h2>
                            <div className="mb-4 text-sm">
                                <p><strong>Bill Number:</strong> {currentBillSale.billNumber}</p>
                                <p><strong>Date:</strong> {currentBillSale.date}</p>
                                <p><strong>Seller:</strong> ALPHONSE N</p>
                                <p><strong>Address:</strong> Nagercoil Pampanvilai Anandanadarkudi Road</p>
                                <p><strong>Contact:</strong> +91 9443391054</p>
                            </div>
                            <div className="mb-6">
                                <p className="text-lg font-semibold mb-2">Bill To:</p>
                                <p className="text-xl font-bold text-gray-800">{currentBillSale.merchantName}</p>
                            </div>

                            <table className="min-w-full mb-6 border-collapse border border-gray-300">
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Description (Banana Type)</th>
                                        <th className="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Weight (kg)</th>
                                        <th className="border border-gray-300 px-4 py-2 text-left text-sm font-medium text-gray-700">Quantity</th>
                                        <th className="border border-gray-300 px-4 py-2 text-right text-sm font-medium text-gray-700">Amount (₹)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {currentBillSale.products && currentBillSale.products.map((product, index) => (
                                        <tr key={index}>
                                            <td className="border border-gray-300 px-4 py-2 text-sm text-gray-800">{product.bananaType}</td>
                                            <td className="border border-gray-300 px-4 py-2 text-sm text-gray-800">{product.weightKg.toFixed(2)}</td>
                                            <td className="border border-gray-300 px-4 py-2 text-sm text-gray-800">{product.quantity}</td>
                                            <td className="border border-gray-300 px-4 py-2 text-right text-sm text-gray-800">
                                                {(product.weightKg * currentBillSale.overallPricePerKg).toFixed(2)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Gross Weight:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold">${(currentBillSale.totalWeightKg || 0).toFixed(2)} kg</td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Wastage (Stem) Weight:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold text-red-600">
                                            - ${(currentBillSale.wastageWeightKg || 0).toFixed(2)} kg
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Net Billed Weight:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold text-blue-700">
                                            ${(currentBillSale.netWeightKg || 0).toFixed(2)} kg
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Total Quantity:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold">${currentBillSale.totalQuantity || '0'}</td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Overall Price/kg:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold">₹${currentBillSale.overallPricePerKg ? currentBillSale.overallPricePerKg.toFixed(2) : '0.00'}</td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Total Amount:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold text-green-700">₹${currentBillSale.totalAmount.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Amount Received:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold text-blue-700">₹${currentBillSale.amountReceived.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td colSpan="3" className="border border-gray-300 px-4 py-2 text-right font-semibold">Balance Due:</td>
                                        <td className="border border-gray-300 px-4 py-2 text-right font-bold text-red-700">₹${currentBillSale.balanceDue.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div className="text-sm mt-6 text-center">
                                <p>Thank you for your business!</p>
                                <p className="mt-4">_________________________</p>
                                <p>Signature</p>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end space-x-3">
                            <button
                                onClick={() => setShowBillModal(false)}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                            >
                                Close
                            </button>
                            <button
                                onClick={handlePrintBill}
                                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                            >
                                Print Bill
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* NEW: Edit Sale Modal */}
            {showEditModal && currentSaleToEdit && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <h2 className="text-2xl font-semibold text-green-700 mb-4">Edit Sale Record for {currentSaleToEdit.billNumber}</h2>
                        <form onSubmit={handleUpdateSale} className="grid grid-cols-1 gap-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="editSaleDate" className="block text-sm font-medium text-gray-700">Date</label>
                                    <input
                                        type="date"
                                        id="editSaleDate"
                                        value={editSaleDate}
                                        onChange={(e) => setEditSaleDate(e.target.value)}
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="editMerchantName" className="block text-sm font-medium text-gray-700">Merchant Name</label>
                                    <input
                                        type="text"
                                        id="editMerchantName"
                                        value={editSaleMerchant}
                                        onChange={(e) => setEditSaleMerchant(e.target.value)}
                                        placeholder="e.g., Green Grocers"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                        required
                                    />
                                </div>
                            </div>

                            <div className="mt-4 border-t border-gray-200 pt-4">
                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Banana Products</h3>
                                {editSaleProducts.map((product, index) => (
                                    <div key={index} className="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-3 p-3 bg-white rounded-md shadow-sm items-end">
                                        <div>
                                            <label htmlFor={`editBananaType-${index}`} className="block text-sm font-medium text-gray-700">Banana Type</label>
                                            <select
                                                id={`editBananaType-${index}`}
                                                value={product.bananaType}
                                                onChange={(e) => handleEditProductChange(index, 'bananaType', e.target.value)}
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                                required
                                            >
                                                <option value="">Select Type</option>
                                                {bananaTypes.map((type) => (
                                                    <option key={type} value={type}>{type}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label htmlFor={`editWeightKg-${index}`} className="block text-sm font-medium text-gray-700">Weight (kg)</label>
                                            <input
                                                type="number"
                                                id={`editWeightKg-${index}`}
                                                value={product.weightKg}
                                                onChange={(e) => handleEditProductChange(index, 'weightKg', e.target.value)}
                                                placeholder="e.g., 100"
                                                step="0.01"
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor={`editQuantity-${index}`} className="block text-sm font-medium text-gray-700">Quantity</label>
                                            <input
                                                type="number"
                                                id={`editQuantity-${index}`}
                                                value={product.quantity}
                                                onChange={(e) => handleEditProductChange(index, 'quantity', e.target.value)}
                                                placeholder="e.g., 50"
                                                step="1"
                                                className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                                required
                                            />
                                        </div>
                                        <div className="flex justify-end sm:justify-start">
                                            {editSaleProducts.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removeEditProductRow(index)}
                                                    className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm"
                                                    >
                                                    Remove
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                <button
                                    type="button"
                                    onClick={addEditProductRow}
                                    className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm mt-2"
                                >
                                    Add Another Product
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Gross Weight (kg)</label>
                                    <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                        {calculateEditGrossWeight().toFixed(2)} kg
                                    </p>
                                </div>
                                <div>
                                    <label htmlFor="editSaleWastageWeight" className="block text-sm font-medium text-gray-700">Wastage (Stem) (kg)</label>
                                    <input
                                        type="number"
                                        id="editSaleWastageWeight"
                                        value={editSaleWastageWeight}
                                        onChange={(e) => setEditSaleWastageWeight(e.target.value)}
                                        placeholder="e.g., 5"
                                        step="0.01"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Net Billed Weight (kg)</label>
                                    <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-blue-700">
                                        {calculateEditNetBilledWeight().toFixed(2)} kg
                                    </p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Total Quantity</label>
                                    <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg">
                                        {calculateEditTotalQuantity()}
                                    </p>
                                </div>
                                <div className="md:col-span-2">
                                    <label htmlFor="editOverallPricePerKg" className="block text-sm font-medium text-gray-700">Overall Price per kg (₹)</label>
                                    <input
                                        type="number"
                                        id="editOverallPricePerKg"
                                        value={editSaleOverallPricePerKg}
                                        onChange={(e) => setEditSaleOverallPricePerKg(e.target.value)}
                                        placeholder="e.g., 25"
                                        step="0.01"
                                        className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                                        required
                                    />
                                </div>
                            </div>

                            <div className="col-span-full">
                                <label className="block text-sm font-medium text-gray-700">New Total Amount Due (₹)</label>
                                <p className="mt-1 block w-full p-2 bg-gray-200 rounded-md shadow-sm font-bold text-lg text-green-700">
                                    ₹{calculateEditTotalAmountDue().toFixed(2)}
                                </p>
                            </div>

                            <div className="col-span-full flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setShowEditModal(false)}
                                    className="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-offset-2 transition duration-150 ease-in-out"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out"
                                >
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Confirmation Modal */}
            {showConfirmModal && (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                        <h2 className="text-xl font-semibold text-red-700 mb-4">Confirm Action</h2>
                        <p className="mb-6 text-gray-700">{confirmMessage}</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={() => setShowConfirmModal(false)}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={confirmAction}
                                className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

export default App;
